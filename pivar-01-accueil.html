<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Collecte Ultra-S√©curis√©</title>
    <style>
        /* PROTECTION CSS MAXIMALE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Blocage absolu s√©lection */
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -khtml-user-select: none !important;
            /* Blocage drag & drop */
            -webkit-user-drag: none !important;
            -moz-user-drag: none !important;
            -o-user-drag: none !important;
            user-drag: none !important;
        }

        /* Annulation s√©lection visuelle */
        *::selection { background: transparent !important; color: inherit !important; }
        *::-moz-selection { background: transparent !important; color: inherit !important; }
        *::-webkit-selection { background: transparent !important; color: inherit !important; }

        /* AUTORISER s√©lection uniquement dans iframe */
        iframe, iframe * {
            -webkit-user-select: auto !important;
            -moz-user-select: auto !important;
            -ms-user-select: auto !important;
            user-select: auto !important;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-banner h1 {
            font-size: 20px;
            margin: 0;
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .security-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 160px);
            border: none;
            display: block;
        }

        .footer {
            background: #f8f9fa;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }

        /* INDICATEURS VISUELS */
        .security-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            z-index: 10000;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
        }

        .session-tracker {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(108, 117, 125, 0.6);
            text-align: center;
            pointer-events: none;
        }

        /* POPUP VIOLATION */
        .violation-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc3545;
            color: white;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 999999;
            display: none;
            text-align: center;
            max-width: 500px;
            animation: alertShake 0.5s infinite;
        }

        @keyframes alertShake {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            25% { transform: translate(-50%, -50%) translateX(-10px); }
            75% { transform: translate(-50%, -50%) translateX(10px); }
        }

        .alert-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .alert-message {
            font-size: 1rem;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .alert-countdown {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffeb3b;
        }

        /* WATERMARKS ANTI-COPIE */
        .watermark-protection {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 1.5rem;
            color: rgba(220, 53, 69, 0.08);
            z-index: 5;
            pointer-events: none;
            font-weight: bold;
            white-space: nowrap;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header-banner h1 { font-size: 16px; }
            .progress-bar { font-size: 12px; padding: 6px; }
            .questionnaire-frame { height: calc(100vh - 140px); }
            .violation-alert { margin: 20px; max-width: none; }
        }

        /* PROTECTION IMPRESSION */
        @media print {
            * { display: none !important; }
            body::before {
                content: "QUESTIONNAIRE PIVAR PROT√âG√â - IMPRESSION INTERDITE";
                display: block !important;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 2rem;
                color: red;
                text-align: center;
            }
        }

        /* CURSEUR PROTECTION */
        .protected-area {
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <!-- Indicateurs s√©curit√© -->
    <div class="security-status" id="securityStatus">
        üõ°Ô∏è ULTRA-S√âCURIS√â ‚Ä¢ Violations: <span id="violationCount">0</span>/3
    </div>

    <div class="session-tracker" id="sessionTracker">
        Session: <span id="sessionDisplay"></span> ‚Ä¢ Candidat: <span id="candidatDisplay">En attente...</span>
    </div>

    <!-- Watermark -->
    <div class="watermark-protection">SESSION PIVAR COLLECTE ULTRA-PROT√âG√âE</div>

    <!-- En-t√™te -->
    <div class="header-banner">
        <h1>üß† PIVAR ‚Äì Protocole d'identification et de valorisation de l'action et de la r√©ussite</h1>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme ultra-s√©curis√©e d'√©valuation comportementale</p>
    </div>

    <!-- Barre de progression -->
    <div class="progress-bar">
        üìä QUESTIONNAIRE 2/7 : PILIER COLLECTE ‚Ä¢ Session ultra-s√©curis√©e ‚Ä¢ Reproduction strictement interdite
    </div>

    <!-- Conteneur principal -->
    <div class="main-container">
        <!-- Notice s√©curit√© -->
        <div class="security-notice">
            üö® QUESTIONNAIRE SOUS SURVEILLANCE MAXIMALE ‚Ä¢ Toute tentative de copie/capture sera sanctionn√©e ‚Ä¢ 3 violations = exclusion automatique
        </div>

        <!-- Questionnaire Tally -->
        <iframe 
            class="questionnaire-frame" 
            src="https://formulaires.pivar.info/r/wMG4Lg"
            title="Questionnaire PIVAR Collecte Ultra-S√©curis√©"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>

        <!-- Pied de page -->
        <div class="footer">
            PIVAR ¬© 2025 ‚Ä¢ Pilier Collecte ‚Ä¢ Protection maximale ‚Ä¢ Violations trac√©es et signal√©es
        </div>
    </div>

    <!-- POPUP VIOLATION -->
    <div id="violationAlert" class="violation-alert">
        <div class="alert-title" id="alertTitle">üö® VIOLATION D√âTECT√âE</div>
        <div class="alert-message" id="alertMessage">Action interdite</div>
        <div class="alert-countdown">Retour dans <span id="alertCountdown">5</span>s</div>
    </div>

    <script>
        // === VARIABLES GLOBALES ===
        let VIOLATIONS = 0;
        const MAX_VIOLATIONS = 3;
        const SESSION_ID = 'COLLECTE_ULTRA_' + Date.now().toString(36).toUpperCase();
        let USER_IP = 'R√©cup√©ration...';
        let CANDIDAT_CODE = '';
        let ALERT_ACTIVE = false;
        let LAST_VIOLATION = 0;

        // Initialisation affichage
        document.getElementById('sessionDisplay').textContent = SESSION_ID.substring(14, 20);
        
        // R√©cup√©ration IP
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(data => { USER_IP = data.ip; })
            .catch(() => { USER_IP = 'IP_MASQU√âE'; });

        console.log('üõ°Ô∏è PIVAR ULTRA-PROTECTION ACTIVE - Session:', SESSION_ID);

        // === FONCTION LOGGING CENTRAL ===
        function logViolation(type, method, details) {
            const violation = {
                id: ++VIOLATIONS,
                timestamp: new Date().toISOString(),
                sessionId: SESSION_ID,
                candidat: CANDIDAT_CODE || 'NON_IDENTIFIE',
                type: type,
                method: method,
                details: details,
                ip: USER_IP,
                userAgent: navigator.userAgent.substring(0, 50)
            };
            
            console.log(`üö® VIOLATION #${VIOLATIONS}:`, violation);
            
            // TODO: Envoi serveur
            // fetch('/api/pivar-violations', { method: 'POST', body: JSON.stringify(violation) });
            
            return violation;
        }

        // === GESTION ALERTES VIOLATION ===
        function showViolationAlert(type, method, details) {
            const now = Date.now();
            
            // Anti-spam (1 seconde minimum entre alertes)
            if (now - LAST_VIOLATION < 1000 || ALERT_ACTIVE) return;
            
            LAST_VIOLATION = now;
            const violation = logViolation(type, method, details);
            
            document.getElementById('violationCount').textContent = VIOLATIONS;
            
            const alert = document.getElementById('violationAlert');
            const title = document.getElementById('alertTitle');
            const message = document.getElementById('alertMessage');
            
            if (VIOLATIONS >= MAX_VIOLATIONS) {
                // EXCLUSION D√âFINITIVE
                title.innerHTML = 'üö´ EXCLUSION AUTOMATIQUE';
                message.innerHTML = `
                    <strong>SESSION TERMIN√âE</strong><br><br>
                    ${VIOLATIONS} violations de s√©curit√© d√©tect√©es.<br>
                    Type: ${type} (${method})<br><br>
                    <strong>Candidat:</strong> ${CANDIDAT_CODE || 'Non identifi√©'}<br>
                    <strong>Session:</strong> ${SESSION_ID}<br>
                    <strong>IP:</strong> ${USER_IP}<br><br>
                    Un rapport complet a √©t√© transmis √† notre √©quipe.
                `;
                
                setTimeout(() => {
                    alert(`EXCLUSION D√âFINITIVE\n\nTrop de tentatives de violation (${VIOLATIONS}).\nUn rapport a √©t√© envoy√© √† l'√©quipe PIVAR.\n\nCandidat: ${CANDIDAT_CODE || 'Non identifi√©'}\nSession: ${SESSION_ID}\n\nVous serez contact√© prochainement.`);
                    window.location.href = 'about:blank';
                }, 6000);
                
            } else if (VIOLATIONS === MAX_VIOLATIONS - 1) {
                // DERNIER AVERTISSEMENT
                title.innerHTML = '‚ö†Ô∏è DERNIER AVERTISSEMENT';
                message.innerHTML = `
                    <strong>VIOLATION ${VIOLATIONS}/${MAX_VIOLATIONS} - ${type}</strong><br>
                    <strong>M√©thode:</strong> ${method}<br><br>
                    <strong>üö® ATTENTION:</strong> La prochaine violation entra√Ænera :<br>
                    ‚Ä¢ Exclusion imm√©diate et d√©finitive<br>
                    ‚Ä¢ Capture d'√©cran de la violation<br>
                    ‚Ä¢ Rapport transmis √† l'√©quipe PIVAR<br>
                    ‚Ä¢ Contact de notre √©quipe<br><br>
                    <em>Votre session est enti√®rement trac√©e.</em>
                `;
                
            } else {
                // AVERTISSEMENTS PROGRESSIFS
                title.innerHTML = `üö® VIOLATION ${VIOLATIONS}/${MAX_VIOLATIONS}`;
                message.innerHTML = `
                    <strong>${type}</strong><br>
                    <strong>M√©thode:</strong> ${method}<br>
                    <strong>D√©tails:</strong> ${details}<br><br>
                    ${MAX_VIOLATIONS - VIOLATIONS} tentative(s) restante(s)<br>
                    <em>Session: ${SESSION_ID}</em>
                `;
            }
            
            alert.style.display = 'block';
            ALERT_ACTIVE = true;
            startAlertCountdown();
        }

        // Countdown alerte
        function startAlertCountdown() {
            let seconds = 5;
            const countdownEl = document.getElementById('alertCountdown');
            
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    document.getElementById('violationAlert').style.display = 'none';
                    ALERT_ACTIVE = false;
                }
            }, 1000);
        }

        // === PROTECTIONS ANTI-COPIE MAXIMALES ===

        // 1. PROTECTION S√âLECTION TEXTE - TOUTES M√âTHODES
        const selectionEvents = ['selectstart', 'dragstart', 'drop'];
        selectionEvents.forEach(eventType => {
            // Protection niveau document
            document.addEventListener(eventType, function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const eventNames = {
                    'selectstart': 'S√âLECTION DE TEXTE',
                    'dragstart': 'GLISSER-D√âPOSER', 
                    'drop': 'D√âPOSER TEXTE'
                };
                
                showViolationAlert('COPIE INTERDITE', eventNames[eventType], 'Tentative de s√©lection d√©tect√©e');
                return false;
            }, true);
            
            // Protection niveau window
            window.addEventListener(eventType, function(e) {
                e.preventDefault();
                return false;
            }, true);
        });

        // 2. PROTECTION CLIC DROIT - ABSOLUE
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            showViolationAlert('MENU CONTEXTUEL', 'CLIC DROIT', 'Acc√®s menu copie tent√©');
            return false;
        }, true);

        // Protection suppl√©mentaire clic droit
        document.oncontextmenu = function(e) {
            e.preventDefault();
            showViolationAlert('MENU CONTEXTUEL', 'CLIC DROIT (oncontextmenu)', 'Contournement d√©tect√©');
            return false;
        };

        // 3. PROTECTION CLAVIER EXHAUSTIVE
        document.addEventListener('keydown', function(e) {
            const key = e.key?.toUpperCase() || 'UNKNOWN';
            const code = e.code || e.keyCode;
            let violation = null;
            let method = '';
            
            // PRINT SCREEN - TOUTES VARIANTES
            if (key === 'PRINTSCREEN' || code === 'PrintScreen' || 
                e.keyCode === 44 || e.keyCode === 42 || e.keyCode === 124 || e.keyCode === 183 ||
                code === 'F13' || code === 'F14' || code === 'F15') {
                violation = 'CAPTURE √âCRAN';
                method = `Print Screen (${key}/${code}/${e.keyCode})`;
            }
            
            // CTRL + TOUCHES (sauf navigation de base)
            else if (e.ctrlKey) {
                const allowedCtrl = ['F5', 'R']; // Refresh autoris√©
                if (!allowedCtrl.includes(key)) {
                    violation = 'RACCOURCI COPIE';
                    method = `Ctrl+${key}`;
                    
                    // Sp√©cial pour raccourcis de copie
                    if (['A', 'C', 'V', 'X', 'S', 'P'].includes(key)) {
                        method += ' (COPIE/S√âLECTION)';
                    } else if (['U', 'I', 'J'].includes(key)) {
                        method += ' (OUTILS D√âVELOPPEUR)';
                    }
                }
            }
            
            // ALT + TOUCHES
            else if (e.altKey && !['TAB', 'F4'].includes(key)) {
                violation = 'RACCOURCI SYST√àME';
                method = `Alt+${key}`;
                
                if (key === 'PRINTSCREEN') {
                    method += ' (CAPTURE FEN√äTRE)';
                }
            }
            
            // WINDOWS/CMD + TOUCHES
            else if (e.metaKey) {
                violation = 'RACCOURCI WINDOWS';
                method = `Win+${key}`;
                
                if (['PRINTSCREEN', 'S'].includes(key)) {
                    method += ' (OUTIL CAPTURE)';
                }
            }
            
            // SHIFT + TOUCHES (s√©lection)
            else if (e.shiftKey) {
                const shiftSelection = ['ARROWLEFT', 'ARROWRIGHT', 'ARROWUP', 'ARROWDOWN', 'HOME', 'END', 'PAGEUP', 'PAGEDOWN'];
                if (shiftSelection.includes(key)) {
                    violation = 'S√âLECTION CLAVIER';
                    method = `Shift+${key}`;
                } else if (key === 'F10') {
                    violation = 'MENU CONTEXTUEL';
                    method = 'Shift+F10 (Menu clavier)';
                }
            }
            
            // TOUCHES FONCTION
            else if (key.startsWith('F') && !['F5'].includes(key)) {
                violation = 'TOUCHE FONCTION';
                method = `${key}`;
                
                if (key === 'F12') {
                    method += ' (OUTILS D√âVELOPPEUR)';
                }
            }
            
            // D√©clencher alerte si violation d√©tect√©e
            if (violation) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                showViolationAlert(violation, method, `Code: ${code}, KeyCode: ${e.keyCode}`);
                return false;
            }
        }, true);

        // 4. PROTECTION SOURIS AVANC√âE
        document.addEventListener('mousedown', function(e) {
            // Double-clic = s√©lection mot
            if (e.detail >= 2) {
                e.preventDefault();
                showViolationAlert('S√âLECTION RAPIDE', 'DOUBLE/TRIPLE-CLIC', `${e.detail} clics d√©tect√©s`);
                return false;
            }
        }, true);

        // Triple-clic sp√©cifique
        document.addEventListener('click', function(e) {
            if (e.detail === 3) {
                e.preventDefault();
                showViolationAlert('S√âLECTION PARAGRAPHE', 'TRIPLE-CLIC', 'S√©lection paragraphe tent√©e');
                return false;
            }
        }, true);

        // 5. D√âTECTION DEVTOOLS HYPERSENSIBLE
        let devtoolsDetected = false;
        function detectDevTools() {
            const threshold = 100; // Plus sensible
            const heightDiff = window.outerHeight - window.innerHeight;
            const widthDiff = window.outerWidth - window.innerWidth;
            
            if ((heightDiff > threshold || widthDiff > threshold) && !devtoolsDetected) {
                devtoolsDetected = true;
                showViolationAlert('OUTILS D√âVELOPPEUR', 'F12/DEVTOOLS', `Dimensions: ${heightDiff}x${widthDiff}`);
                
                // Reset apr√®s 5 secondes
                setTimeout(() => { devtoolsDetected = false; }, 5000);
            }
        }

        // 6. PROTECTION MOBILE RENFORC√âE
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // Gestes multi-touch
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length >= 2) {
                    e.preventDefault();
                    showViolationAlert('GESTE MOBILE', 'MULTI-TOUCH', `${e.touches.length} doigts d√©tect√©s`);
                }
            }, true);
            
            // Rotation √©cran
            window.addEventListener('orientationchange', function() {
                showViolationAlert('ROTATION MOBILE', 'CHANGEMENT ORIENTATION', 'Capture d\'√©cran suspect√©e');
            });
            
            // Long press (menu contextuel mobile)
            let touchTimer;
            document.addEventListener('touchstart', function(e) {
                touchTimer = setTimeout(() => {
                    showViolationAlert('MENU MOBILE', 'APPUI LONG', 'Long press d√©tect√©');
                }, 500);
            });
            
            document.addEventListener('touchend', function() {
                clearTimeout(touchTimer);
            });
        }

        // 7. SURVEILLANCE ACTIVIT√â FEN√äTRE
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üîç Candidat a quitt√© l\'onglet');
            } else {
                console.log('üîç Candidat est revenu');
            }
        });

        // === INTERCEPTION CODE CANDIDAT ===
        window.addEventListener('message', function(event) {
            if (event.origin === 'https://formulaires.pivar.info' || event.origin === 'https://tally.so') {
                try {
                    const data = event.data;
                    if (data && typeof data === 'string') {
                        const codeMatch = data.match(/([A-Z]{4}-[A-Z0-9]{5})|([A-Z0-9]{4}-[A-Z0-9]{4})/);
                        if (codeMatch) {
                            CANDIDAT_CODE = codeMatch[0];
                            document.getElementById('candidatDisplay').textContent = CANDIDAT_CODE;
                            console.log('üë§ Candidat identifi√©:', CANDIDAT_CODE);
                        }
                    }
                } catch (e) {
                    // Donn√©es non parsables
                }
            }
        });

        // === SURVEILLANCE CONTINUE ===
        setInterval(detectDevTools, 1000);

        // === INITIALISATION ===
        window.addEventListener('load', function() {
            console.log('‚úÖ PIVAR ULTRA-PROTECTION INITIALIS√âE');
            console.log('üìä Violations max autoris√©es:', MAX_VIOLATIONS);
        });

        window.addEventListener('beforeunload', function() {
            console.log(`üìä Session termin√©e - ${VIOLATIONS} violations d√©tect√©es`);
        });

        // === PROTECTION CONSOLE ===
        console.log('%cüõ°Ô∏è PIVAR ULTRA-S√âCURIT√â ACTIVE', 'color: red; font-size: 18px; font-weight: bold; background: yellow; padding: 5px;');
        console.log('%cTOUTE TENTATIVE DE VIOLATION EST D√âTECT√âE ET TRAC√âE', 'color: red; font-size: 14px; font-weight: bold;');
        console.log('%cCandidat: respectez les consignes pour √©viter l\'exclusion', 'color: orange; font-size: 12px;');
    </script>
</body>
</html>
