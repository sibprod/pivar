<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Accueil S√©curis√©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* PROTECTION CSS ABSOLUE */
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-touch-callout: none !important;
            -khtml-user-select: none !important;
        }

        /* BLOCAGE S√âLECTION GLOBAL */
        *::selection { background: transparent !important; }
        *::-moz-selection { background: transparent !important; }
        *::-webkit-selection { background: transparent !important; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            /* PROTECTION DRAG & DROP */
            -webkit-user-drag: none !important;
            -khtml-user-drag: none !important;
            -moz-user-drag: none !important;
            -o-user-drag: none !important;
            user-drag: none !important;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-banner h1 {
            font-size: 20px;
            margin: 0;
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        .security-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 160px);
            border: none;
            display: block;
        }

        .footer {
            background: #f8f9fa;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
        }

        /* VIOLATIONS COUNTER VISIBLE */
        .violations-counter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
        }

        /* ALERTES D'ESCALADE */
        .escalade-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #dc3545;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            z-index: 999999;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: none;
            text-align: center;
        }

        .alert-level-1 { border-color: #ffc107; }
        .alert-level-2 { border-color: #fd7e14; }
        .alert-level-3 { border-color: #dc3545; animation: shake 0.5s infinite; }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            25% { transform: translate(-50%, -50%) translateX(-5px); }
            75% { transform: translate(-50%, -50%) translateX(5px); }
        }

        .alert-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }

        .alert-message {
            font-size: 1rem;
            margin-bottom: 20px;
            line-height: 1.4;
            color: #333;
        }

        .alert-countdown {
            font-size: 1.2rem;
            color: #dc3545;
            font-weight: bold;
        }

        .close-alert-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }

        /* WATERMARKS */
        .watermark-tracking {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(108, 117, 125, 0.4);
            z-index: 1000;
            pointer-events: none;
            text-align: center;
        }

        /* Styles mobiles */
        @media (max-width: 768px) {
            .header-banner h1 {
                font-size: 16px;
            }
            .progress-bar {
                font-size: 12px;
                padding: 6px;
            }
            .questionnaire-frame {
                height: calc(100vh - 140px);
            }
            .escalade-alert {
                margin: 20px;
                max-width: none;
                left: 20px;
                right: 20px;
                transform: translateY(-50%);
            }
        }

        /* PROTECTION PRINT */
        @media print {
            body * { visibility: hidden !important; }
            body::before {
                content: "DOCUMENT PROT√âG√â - IMPRESSION INTERDITE";
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 2rem;
                color: red;
                visibility: visible !important;
            }
        }
    </style>
</head>
<body>
    <!-- Compteur de violations visible -->
    <div class="violations-counter" id="violationsCounter">
        üõ°Ô∏è Violations: <span id="violationCount">0</span>/4
    </div>

    <!-- Watermark de session -->
    <div class="watermark-tracking" id="sessionWatermark">
        Session PIVAR s√©curis√©e ‚Ä¢ ID: <span id="sessionDisplay"></span>
    </div>

    <!-- En-t√™te professionnel PIVAR -->
    <div class="header-banner">
        <h1>üß† PIVAR ‚Äì Protocole d'identification et de valorisation de l'action et de la r√©ussite</h1>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme s√©curis√©e d'√©valuation comportementale</p>
    </div>

    <!-- Barre de progression -->
    <div class="progress-bar">
        üìä QUESTIONNAIRE 1/7 : ACCUEIL PIVAR ‚Ä¢ Session s√©curis√©e ‚Ä¢ Reproduction interdite - Protection CONTINEW
    </div>

    <!-- Conteneur principal -->
    <div class="main-container">
        <!-- Notice de s√©curit√© -->
        <div class="security-notice">
            ‚ö†Ô∏è √âVALUATION SOUS SURVEILLANCE ‚Ä¢ Votre activit√© est enregistr√©e ‚Ä¢ Maximum 4 violations autoris√©es avant exclusion
        </div>

        <!-- Questionnaire Tally int√©gr√© -->
        <iframe 
            class="questionnaire-frame" 
            src="https://formulaires.pivar.info/r/mJog7Y"
            title="Questionnaire PIVAR S√©curis√©"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>

        <!-- Pied de page -->
        <div class="footer">
            PIVAR ¬© 2025 ‚Ä¢ Toute reproduction interdite ‚Ä¢ Violations enregistr√©es et signal√©es
        </div>
    </div>

    <!-- ALERTE D'ESCALADE -->
    <div id="escaladeAlert" class="escalade-alert">
        <div class="alert-title" id="alertTitle">
            üö® VIOLATION D√âTECT√âE
        </div>
        <div class="alert-message" id="alertMessage">
            Action non autoris√©e
        </div>
        <div class="alert-countdown" id="alertCountdown">
            Fermeture dans <span id="countdown">5</span>s
        </div>
        <button class="close-alert-btn" onclick="closeAlert()">
            J'AI COMPRIS
        </button>
    </div>

    <script>
        // R√âCUP√âRATION AUTOMATIQUE DONN√âES CANDIDAT
        function getCandidatFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                nom: urlParams.get('nom') || urlParams.get('name') || 'CANDIDAT_INCONNU',
                prenom: urlParams.get('prenom') || urlParams.get('firstname') || '',
                email: urlParams.get('email') || '',
                code: urlParams.get('code') || urlParams.get('access_code') || ''
            };
        }

        // SYST√àME D'ESCALADE PROGRESSIVE
        const PIVAR_ESCALADE = {
            sessionId: 'PIVAR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
            candidat: getCandidatFromURL(),
            violations: [],
            violationCount: 0,
            maxViolations: 4,
            ip: 'R√©cup√©ration...',
            startTime: new Date(),
            lastViolation: 0
        };

        // R√©cup√©ration IP
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                PIVAR_ESCALADE.ip = data.ip;
                updateDisplay();
            })
            .catch(() => {
                PIVAR_ESCALADE.ip = 'IP_MASQU√âE';
                updateDisplay();
            });

        // Mise √† jour affichage
        function updateDisplay() {
            document.getElementById('sessionDisplay').textContent = PIVAR_ESCALADE.sessionId.substring(6, 16);
            document.getElementById('violationCount').textContent = PIVAR_ESCALADE.violationCount;
        }

        // GESTION DES VIOLATIONS AVEC ESCALADE
        function handleViolation(violationType, details) {
            const now = Date.now();
            
            // √âviter spam (1 seconde entre violations)
            if (now - PIVAR_ESCALADE.lastViolation < 1000) {
                return;
            }
            
            PIVAR_ESCALADE.lastViolation = now;
            PIVAR_ESCALADE.violationCount++;
            
            const violation = {
                id: PIVAR_ESCALADE.violationCount,
                timestamp: new Date().toISOString(),
                type: violationType,
                details: details,
                sessionId: PIVAR_ESCALADE.sessionId,
                ip: PIVAR_ESCALADE.ip,
                candidat: PIVAR_ESCALADE.candidat.nom
            };
            
            PIVAR_ESCALADE.violations.push(violation);
            updateDisplay();
            
            // LOG VISIBLE (dissuasion)
            console.log(`üö® VIOLATION #${PIVAR_ESCALADE.violationCount}:`, violation);
            
            // ESCALADE SELON LE NOMBRE DE VIOLATIONS
            showEscaladeAlert(PIVAR_ESCALADE.violationCount, violationType);
        }

        // ALERTES D'ESCALADE PROGRESSIVE
        function showEscaladeAlert(violationNumber, violationType) {
            const alert = document.getElementById('escaladeAlert');
            const title = document.getElementById('alertTitle');
            const message = document.getElementById('alertMessage');
            
            // Supprimer les classes d'escalade pr√©c√©dentes
            alert.classList.remove('alert-level-1', 'alert-level-2', 'alert-level-3');
            
            if (violationNumber === 1) {
                // PREMI√àRE VIOLATION - AVERTISSEMENT
                alert.classList.add('alert-level-1');
                title.innerHTML = '‚ö†Ô∏è PREMI√àRE VIOLATION';
                message.innerHTML = `
                    <strong>${violationType} d√©tect√©</strong><br><br>
                    <strong>AVERTISSEMENT :</strong> Cette action est interdite.<br>
                    Vous disposez encore de <strong>${PIVAR_ESCALADE.maxViolations - violationNumber} tentatives</strong> avant exclusion.<br><br>
                    <em>Votre session est enregistr√©e.</em>
                `;
                
            } else if (violationNumber === 2) {
                // DEUXI√àME VIOLATION - S√âRIEUX
                alert.classList.add('alert-level-2');
                title.innerHTML = 'üî∂ DEUXI√àME VIOLATION';
                message.innerHTML = `
                    <strong>${violationType} d√©tect√©</strong><br><br>
                    <strong>ATTENTION :</strong> Comportement r√©p√©t√© non autoris√©.<br>
                    Plus que <strong>${PIVAR_ESCALADE.maxViolations - violationNumber} violations</strong> autoris√©es.<br><br>
                    <em>Un rapport est en cours de g√©n√©ration.</em>
                `;
                
            } else if (violationNumber === 3) {
                // TROISI√àME VIOLATION - DERNIER AVERTISSEMENT
                alert.classList.add('alert-level-3');
                title.innerHTML = 'üö® DERNIER AVERTISSEMENT';
                message.innerHTML = `
                    <strong>${violationType} - 3√®me violation</strong><br><br>
                    <strong>‚ö†Ô∏è DERNI√àRE CHANCE :</strong><br>
                    Une violation suppl√©mentaire entra√Ænera :<br>
                    ‚Ä¢ <strong>Fermeture imm√©diate</strong> de votre session<br>
                    ‚Ä¢ <strong>Capture d'√©cran</strong> de votre violation<br>
                    ‚Ä¢ <strong>Contact par un membre</strong> de notre √©quipe<br><br>
                    <strong>Candidat :</strong> ${PIVAR_ESCALADE.candidat.prenom} ${PIVAR_ESCALADE.candidat.nom}<br>
                    <strong>Email :</strong> ${PIVAR_ESCALADE.candidat.email}<br>
                    <em style="color: #dc3545;">Votre IP ${PIVAR_ESCALADE.ip} est enregistr√©e.</em>
                `;
                
            } else if (violationNumber >= 4) {
                // QUATRI√àME+ VIOLATION - EXCLUSION
                alert.classList.add('alert-level-3');
                title.innerHTML = 'üö´ SESSION TERMIN√âE';
                message.innerHTML = `
                    <strong>EXCLUSION AUTOMATIQUE</strong><br><br>
                    Trop de violations d√©tect√©es (${violationNumber}).<br><br>
                    <strong>Actions automatiques :</strong><br>
                    ‚Ä¢ Fermeture de votre session<br>
                    ‚Ä¢ Rapport envoy√© √† notre √©quipe<br>
                    ‚Ä¢ Un membre PIVAR vous contactera<br><br>
                    <strong>Session :</strong> ${PIVAR_ESCALADE.sessionId}<br>
                    <strong>IP :</strong> ${PIVAR_ESCALADE.ip}
                `;
                
                // FERMETURE APR√àS 8 SECONDES
                setTimeout(() => {
                    generateViolationReport();
                    alert('Session termin√©e pour violations r√©p√©t√©es.\nUn rapport a √©t√© transmis √† notre √©quipe.\nVous serez contact√©(e) prochainement.');
                    window.location.href = 'about:blank';
                }, 8000);
            }
            
            alert.style.display = 'block';
            startCountdown();
        }

        // COUNTDOWN AUTOMATIQUE
        function startCountdown() {
            let seconds = 5;
            const countdownElement = document.getElementById('countdown');
            
            const interval = setInterval(() => {
                seconds--;
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    closeAlert();
                }
            }, 1000);
        }

        // FERMER L'ALERTE
        function closeAlert() {
            document.getElementById('escaladeAlert').style.display = 'none';
        }

        // G√âN√âRATION RAPPORT DE VIOLATION
        function generateViolationReport() {
            const report = {
                session_id: PIVAR_ESCALADE.sessionId,
                candidat: PIVAR_ESCALADE.candidat,
                ip: PIVAR_ESCALADE.ip,
                start_time: PIVAR_ESCALADE.startTime.toISOString(),
                end_time: new Date().toISOString(),
                total_violations: PIVAR_ESCALADE.violationCount,
                violations_detail: PIVAR_ESCALADE.violations,
                user_agent: navigator.userAgent,
                url: window.location.href
            };
            
            console.log('üìÑ RAPPORT DE VIOLATION G√âN√âR√â:', report);
            
            // Envoi vers serveur (√† impl√©menter)
            // fetch('/api/pivar-violation-report', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(report)
            // });
        }

        // PROTECTION CONTRE TOUTES LES M√âTHODES
        
        // 1. Protection clavier
        document.addEventListener('keydown', function(e) {
            const forbiddenKeys = [
                'F12', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11',
                'PrintScreen', 'Insert', 'Delete'
            ];
            
            if (forbiddenKeys.includes(e.key) || 
                e.ctrlKey || e.altKey || e.metaKey || 
                (e.shiftKey && e.key === 'F10')) {
                
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const violation = `${e.ctrlKey ? 'Ctrl+' : ''}${e.altKey ? 'Alt+' : ''}${e.metaKey ? 'Win+' : ''}${e.key || 'Touche syst√®me'}`;
                handleViolation('CLAVIER INTERDIT', violation);
                return false;
            }
        }, true);

        // 2. Protection souris
        ['contextmenu', 'selectstart', 'dragstart'].forEach(eventType => {
            document.addEventListener(eventType, function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const typeNames = {
                    'contextmenu': 'CLIC DROIT',
                    'selectstart': 'S√âLECTION TEXTE', 
                    'dragstart': 'GLISSER-D√âPOSER'
                };
                
                handleViolation(typeNames[eventType] || eventType.toUpperCase(), 'Action souris interdite');
                return false;
            }, true);
        });

        // 3. Protection DevTools
        let devToolsWarned = false;
        function detectDevTools() {
            const threshold = 120;
            if ((window.outerHeight - window.innerHeight > threshold || 
                 window.outerWidth - window.innerWidth > threshold) && !devToolsWarned) {
                
                devToolsWarned = true;
                handleViolation('OUTILS D√âVELOPPEUR', 'F12 ou DevTools d√©tect√©s');
                
                setTimeout(() => { devToolsWarned = false; }, 5000);
            }
        }

        // 4. Protection mobile
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length >= 3) {
                    e.preventDefault();
                    handleViolation('GESTE MOBILE', `${e.touches.length} doigts - capture suspect√©e`);
                }
            });
        }

        // SURVEILLANCE CONTINUE
        setInterval(detectDevTools, 1000);

        // INITIALISATION
        window.addEventListener('load', function() {
            updateDisplay();
            console.log('üõ°Ô∏è PIVAR Escalade Progressive - Session:', PIVAR_ESCALADE.sessionId);
            console.log('‚ö†Ô∏è Maximum', PIVAR_ESCALADE.maxViolations, 'violations autoris√©es');
        });

        // CLEANUP
        window.addEventListener('beforeunload', function() {
            if (PIVAR_ESCALADE.violationCount > 0) {
                generateViolationReport();
            }
        });
    </script>
</body>
</html>
