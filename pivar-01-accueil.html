<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PIVAR - Collecte Mobile S√©curis√©</title>
    <style>
        /* PROTECTION CSS MOBILE MAXIMALE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Blocage s√©lection absolu */
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            /* Mobile sp√©cifique */
            -webkit-touch-callout: none !important;
            -webkit-tap-highlight-color: transparent !important;
            /* Drag & drop */
            -webkit-user-drag: none !important;
            -moz-user-drag: none !important;
        }

        /* Annulation s√©lection visuelle */
        *::selection { background: transparent !important; }
        *::-moz-selection { background: transparent !important; }

        /* AUTORISER s√©lection uniquement dans iframe */
        iframe * {
            -webkit-user-select: auto !important;
            -moz-user-select: auto !important;
            user-select: auto !important;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            /* Emp√™cher zoom */
            touch-action: pan-x pan-y;
            overflow-x: hidden;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-banner h1 {
            font-size: 16px;
            margin: 0;
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .main-container {
            background: white;
            min-height: calc(100vh - 80px);
            position: relative;
        }

        .mobile-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 0;
            font-size: 12px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 120px);
            border: none;
            display: block;
        }

        /* ALERTE MOBILE SP√âCIFIQUE */
        .mobile-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #dc3545;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 999999;
            display: none;
            text-align: center;
            max-width: 90%;
            font-size: 14px;
        }

        .alert-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }

        .alert-message {
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .alert-countdown {
            font-size: 1rem;
            color: #dc3545;
            font-weight: bold;
        }

        /* WATERMARKS MOBILES */
        .mobile-watermark {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 1rem;
            color: rgba(220, 53, 69, 0.1);
            z-index: 1;
            pointer-events: none;
            white-space: nowrap;
        }

        /* INDICATEUR SURVEILLANCE MOBILE */
        .mobile-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 9px;
            z-index: 1000;
        }

        /* Emp√™cher screenshots par overlay (partiel) */
        .screenshot-protection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Protection overlay -->
    <div class="screenshot-protection"></div>

    <!-- Watermark mobile -->
    <div class="mobile-watermark">PIVAR MOBILE SURVEILL√â</div>

    <!-- Status surveillance -->
    <div class="mobile-status" id="mobileStatus">
        üì± Surveill√©
    </div>

    <!-- En-t√™te mobile adapt√© -->
    <div class="header-banner">
        <h1>üß† PIVAR ‚Äì √âvaluation Mobile S√©curis√©e</h1>
    </div>

    <!-- Barre de progression mobile -->
    <div class="progress-bar">
        üìä COLLECTE 2/7 ‚Ä¢ Mobile s√©curis√©
    </div>

    <!-- Conteneur principal -->
    <div class="main-container">
        <!-- Avertissement mobile -->
        <div class="mobile-warning">
            üì± MODE MOBILE ‚Ä¢ Questionnaire surveill√© ‚Ä¢ Captures d'√©cran d√©tect√©es = exclusion ‚Ä¢ Droits d'auteur prot√©g√©s
        </div>

        <!-- Questionnaire -->
        <iframe 
            class="questionnaire-frame" 
            src="https://formulaires.pivar.info/r/wMG4Lg"
            title="Questionnaire PIVAR Mobile"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin">
        </iframe>
    </div>

    <!-- ALERTE MOBILE -->
    <div id="mobileAlert" class="mobile-alert">
        <div class="alert-title" id="alertTitle">‚ö†Ô∏è Action D√©tect√©e</div>
        <div class="alert-message" id="alertMessage">Message</div>
        <div class="alert-countdown">Retour dans <span id="countdown">5</span>s</div>
    </div>

    <script>
        // VARIABLES MOBILES
        let mobileViolations = 0;
        const sessionId = 'MOBILE_' + Date.now().toString(36);
        let alertActive = false;
        let lastViolation = 0;

        // D√©tection mobile
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);

        console.log('üì± PIVAR Mobile Protection - Device:', isMobile ? 'Mobile' : 'Desktop');
        console.log('üì± OS d√©tect√©:', isIOS ? 'iOS' : isAndroid ? 'Android' : 'Autre');

        // FONCTION VIOLATION MOBILE
        function handleMobileViolation(type, method, details) {
            const now = Date.now();
            if (now - lastViolation < 2000 || alertActive) return; // Anti-spam 2 secondes
            
            lastViolation = now;
            mobileViolations++;
            
            console.log(`üì± VIOLATION MOBILE #${mobileViolations}: ${type} - ${method}`);
            
            const alert = document.getElementById('mobileAlert');
            const title = document.getElementById('alertTitle');
            const message = document.getElementById('alertMessage');
            
            if (mobileViolations >= 2) {
                // Exclusion rapide sur mobile (2 violations au lieu de 3)
                title.textContent = 'üö´ Parcours Suspendu';
                message.innerHTML = `
                    <strong>Violation mobile d√©tect√©e : ${type}</strong><br><br>
                    Sur mobile, les tentatives de capture sont plus facilement d√©tect√©es.<br><br>
                    Votre parcours est suspendu. Notre √©quipe reviendra vers vous.
                `;
                
                setTimeout(() => {
                    alert('Parcours PIVAR suspendu (violation mobile).\nNotre √©quipe reprendra contact.');
                    window.location.href = 'https://sibprod.github.io/pivar/droits-auteur.html?mobile=violation';
                }, 6000);
                
            } else {
                // Premier avertissement mobile
                title.textContent = 'üì± Avertissement Mobile';
                message.innerHTML = `
                    <strong>Action d√©tect√©e : ${type}</strong><br><br>
                    Les questionnaires PIVAR sont prot√©g√©s par droits d'auteur.<br><br>
                    Sur mobile, toute tentative de capture entra√Æne une exclusion imm√©diate.
                `;
            }
            
            alert.style.display = 'block';
            alertActive = true;
            startMobileCountdown();
        }

        // Countdown mobile
        function startMobileCountdown() {
            let seconds = 5;
            const countdownEl = document.getElementById('countdown');
            
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    document.getElementById('mobileAlert').style.display = 'none';
                    alertActive = false;
                }
            }, 1000);
        }

        // === PROTECTIONS MOBILES SP√âCIFIQUES ===

        if (isMobile) {
            // 1. GESTES MULTI-TOUCH (capture gestuelle)
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length >= 2) {
                    e.preventDefault();
                    handleMobileViolation('GESTE MULTI-TOUCH', 'SCREENSHOT_GESTURE', `${e.touches.length} doigts`);
                }
            }, { passive: false });

            // 2. APPUI LONG (menu contextuel mobile)
            let touchTimer;
            let touchStartTime;
            
            document.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchTimer = setTimeout(() => {
                    handleMobileViolation('APPUI LONG', 'CONTEXT_MENU', 'Menu contextuel mobile');
                }, 800);
            });
            
            document.addEventListener('touchend', function(e) {
                clearTimeout(touchTimer);
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration > 1000) {
                    handleMobileViolation('APPUI LONG', 'LONG_PRESS', `${touchDuration}ms`);
                }
            });

            // 3. CHANGEMENT ORIENTATION (capture suspect√©e)
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    handleMobileViolation('ROTATION √âCRAN', 'ORIENTATION_CHANGE', 'Capture suspect√©e');
                }, 500);
            });

            // 4. SURVEILLANCE VISIBILIT√â (app background)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('üì± App mise en arri√®re-plan - capture possible');
                    // Ne pas alerter imm√©diatement (trop de faux positifs)
                    setTimeout(() => {
                        if (document.hidden) {
                            handleMobileViolation('APP BACKGROUND', 'HIDDEN_CAPTURE', 'Capture en arri√®re-plan suspect√©e');
                        }
                    }, 3000);
                }
            });

            // 5. D√âTECTION ZOOM (pinch to zoom)
            let initialDistance = 0;
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialDistance = Math.sqrt(
                        Math.pow(touch2.pageX - touch1.pageX, 2) +
                        Math.pow(touch2.pageY - touch1.pageY, 2)
                    );
                }
            });

            document.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.sqrt(
                        Math.pow(touch2.pageX - touch1.pageX, 2) +
                        Math.pow(touch2.pageY - touch1.pageY, 2)
                    );
                    
                    if (Math.abs(currentDistance - initialDistance) > 50) {
                        e.preventDefault();
                        handleMobileViolation('ZOOM D√âTECT√â', 'PINCH_ZOOM', 'Tentative zoom/capture');
                    }
                }
            }, { passive: false });

            // 6. PROTECTION S√âLECTION MOBILE
            document.addEventListener('selectstart', function(e) {
                if (!e.target.closest('iframe')) {
                    e.preventDefault();
                    handleMobileViolation('S√âLECTION MOBILE', 'TEXT_SELECT', 'S√©lection de texte mobile');
                    return false;
                }
            });

        } else {
            // Protection desktop classique si pas mobile
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                handleMobileViolation('CLIC DROIT', 'CONTEXT_MENU', 'Menu contextuel desktop');
                return false;
            });
        }

        // === PROTECTIONS COMMUNES MOBILE/DESKTOP ===

        // Clavier (si clavier connect√© sur mobile)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'PrintScreen' || e.keyCode === 44 || 
                (e.ctrlKey && ['C', 'A', 'V', 'S'].includes(e.key?.toUpperCase()))) {
                e.preventDefault();
                handleMobileViolation('CLAVIER', `${e.ctrlKey ? 'CTRL+' : ''}${e.key}`, 'Raccourci clavier d√©tect√©');
                return false;
            }
        });

        // INITIALISATION MOBILE
        window.addEventListener('load', function() {
            console.log('üì± PIVAR Mobile Protection initialis√©e');
            document.getElementById('mobileStatus').textContent = 
                `üì± ${isMobile ? (isIOS ? 'iOS' : 'Android') : 'Desktop'} Surveill√©`;
        });

        // Message d√©veloppeur mobile
        console.log('%cüì± PIVAR MOBILE S√âCURIS√â', 'color: blue; font-size: 16px; font-weight: bold;');
        console.log('%cProtection partielle sur mobile - Captures natives non d√©tectables', 'color: orange; font-size: 12px;');
    </script>
</body>
</html>
