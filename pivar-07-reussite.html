<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Mode de R√©ussite S√©curis√©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #ffc107;
            color: #333;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .security-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .rgpd-notice {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 0;
            font-size: 12px;
            color: #155724;
            text-align: center;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 220px);
            border: none;
            display: block;
        }

        /* TRACKING INDICATOR */
        .tracking-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* DEBUG PANEL */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            max-width: 400px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        /* POPUP VIOLATION */
        .violation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 35px;
            border-radius: 15px;
            border: 4px solid #dc3545;
            box-shadow: 0 0 50px rgba(220, 53, 69, 0.3);
            z-index: 999999;
            display: none;
            text-align: center;
            max-width: 600px;
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #dc3545;
        }

        .popup-message {
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #333;
        }

        .popup-countdown {
            font-size: 1.1rem;
            color: #dc3545;
            font-weight: bold;
        }

        /* COULEURS D'ESCALADE */
        .violation-1 { 
            border-color: #ffc107; 
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
        }
        .violation-2 { 
            border-color: #fd7e14; 
            box-shadow: 0 0 35px rgba(253, 126, 20, 0.4);
        }
        .violation-3 { 
            border-color: #dc3545; 
            box-shadow: 0 0 40px rgba(220, 53, 69, 0.4);
        }
        .violation-4 { 
            border-color: #6f42c1; 
            box-shadow: 0 0 45px rgba(111, 66, 193, 0.5);
        }
        .violation-5 { 
            border-color: #000; 
            background: #f8f9fa;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.6);
        }

        /* BLOCAGE MOBILE */
        .device-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .device-blocker { display: flex; }
        }
    </style>
</head>
<body>
    <!-- BLOCAGE MOBILE -->
    <div class="device-blocker">
        <h1>üì± Acc√®s Smartphone Non Autoris√©</h1>
        <p><strong>Cette √©valuation PIVAR n√©cessite un ordinateur ou tablette.</strong></p>
        <p>L'interface questionnaire ne s'affiche pas correctement sur smartphone.</p>
    </div>

    <!-- TRACKING INDICATOR -->
    <div class="tracking-indicator" id="trackingIndicator">
        üèÜ QUESTIONNAIRE FINAL
    </div>

    <!-- DEBUG PANEL -->
    <div class="debug-panel" id="debugPanel">
        <div><strong>üîç D√âTECTIONS ACTIVES:</strong></div>
        <div id="debugLogs">Aucune d√©tection encore...</div>
    </div>

    <!-- Interface principale -->
    <div class="main-container">
        <div class="header-banner">
            <h1>üß† PIVAR ‚Äì Protocole d'identification et de valorisation de l'action et de la r√©ussite</h1>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme s√©curis√©e d'√©valuation comportementale</p>
        </div>

        <div class="progress-bar">
            üèÜ QUESTIONNAIRE 7/7 : MODE DE R√âUSSITE D'EXCELLENCE ‚Ä¢ Derni√®re √©tape ‚Ä¢ Session surveill√©e
        </div>

        <div class="security-notice">
            ‚ö†Ô∏è ATTENTION : Cette session est enti√®rement surveill√©e et enregistr√©e ‚Ä¢ Toute tentative de copie ou capture sera d√©tect√©e et trac√©e ‚Ä¢ Questionnaires prot√©g√©s par droits d'auteur
        </div>

        <div class="rgpd-notice">
            üìã <strong>Information RGPD :</strong> Conform√©ment √† l'article 6.1.f du RGPD, cette session technique est enregistr√©e sur la base de nos int√©r√™ts l√©gitimes de protection de la propri√©t√© intellectuelle et de pr√©vention des violations de droits d'auteur. Ce traitement est n√©cessaire √† la protection de nos questionnaires prot√©g√©s et proportionn√© √† cet objectif l√©gitime.
        </div>

        <iframe 
            class="questionnaire-frame" 
            src="https://tally.so/r/nPPxY0"
            title="Questionnaire PIVAR Mode de R√©ussite"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-top-navigation">
        </iframe>
    </div>

    <!-- POPUP VIOLATION -->
    <div id="violationPopup" class="violation-popup">
        <div class="popup-title" id="popupTitle">‚ö†Ô∏è VIOLATION D√âTECT√âE</div>
        <div class="popup-message" id="popupMessage">Message</div>
        <div class="popup-countdown">Retour √† votre questionnaire dans <span id="countdown">10</span> secondes</div>
    </div>

    <script>
        // ============== VARIABLES GLOBALES ==============
        const sessionData = {
            id: 'PIVAR_' + Date.now().toString(36).toUpperCase(),
            questionnaire: 'REUSSITE',
            code_tally: 'nPPxY0',
            violations: [],
            totalViolations: 0,
            deviceInfo: {
                userAgent: navigator.userAgent,
                screenRes: `${screen.width}x${screen.height}`,
                platform: navigator.platform,
                touchPoints: navigator.maxTouchPoints || 0
            }
        };

        let alertActive = false;
        let debugLogs = [];

        // Afficher session
        document.getElementById('trackingIndicator').textContent = `üèÜ ${sessionData.id}`;

        // ============== FONCTION DEBUG ==============
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp}: ${message}`;
            debugLogs.push(logEntry);
            
            // Afficher les 5 derniers logs
            const debugPanel = document.getElementById('debugLogs');
            debugPanel.innerHTML = debugLogs.slice(-5).join('<br>');
            
            console.log('üîç DEBUG:', message);
        }

        // ============== ENVOI ZAPIER IMM√âDIAT ==============
        function sendToZapierImmediate(violationData) {
            const zapierWebhook = 'https://hooks.zapier.com/hooks/catch/YOUR_WEBHOOK_ID/';
            
            const payload = {
                session_id: sessionData.id,
                questionnaire: sessionData.questionnaire,
                code_tally: sessionData.code_tally,
                timestamp: new Date().toISOString(),
                violation_count: sessionData.totalViolations + 1,
                max_violations: 5,
                violation_details: violationData,
                priority: 'IMMEDIATE',
                device_info: sessionData.deviceInfo,
                status: (sessionData.totalViolations >= 4) ? 'EXCLU' : 'SURVEILLANCE'
            };

            // ENVOI GARANTI
            navigator.sendBeacon(zapierWebhook, JSON.stringify(payload));
            
            fetch(zapierWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                keepalive: true
            }).catch(() => {
                addDebugLog('üì° Beacon envoy√© (fetch failed)');
            });

            console.log('üì° ZAPIER ENVOY√â:', payload);
            addDebugLog(`üì° Zapier: ${violationData.type} - ${violationData.method}`);
        }

        // ============== D√âTECTION DE VIOLATION ==============
        function detectViolation(type, method, details) {
            addDebugLog(`üö® VIOLATION: ${type} - ${method}`);
            
            const violationData = {
                type: type,
                method: method,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            // ENVOI IMM√âDIAT
            sendToZapierImmediate(violationData);
            
            // Incr√©menter violations
            sessionData.violations.push(violationData);
            sessionData.totalViolations++;
            
            // Afficher popup si pas d√©j√† actif
            if (!alertActive) {
                showViolationPopup(type, method, sessionData.totalViolations);
            }
            
            // Redirection √† 5 violations
            if (sessionData.totalViolations >= 5) {
                setTimeout(() => {
                    window.location.href = 'https://www.pivar.info/cgu-rgpd-droitsauteurs';
                }, 30000);
            }
        }

        // ============== POPUP VIOLATION ==============
        function showViolationPopup(type, method, violationCount) {
            const popup = document.getElementById('violationPopup');
            const title = document.getElementById('popupTitle');
            const message = document.getElementById('popupMessage');
            
            // COULEURS D'ESCALADE
            const violationClasses = ['violation-1', 'violation-2', 'violation-3', 'violation-4', 'violation-5'];
            popup.className = `violation-popup ${violationClasses[violationCount - 1] || 'violation-5'}`;
            
            // TEMPORISATION PROGRESSIVE : 10, 15, 20, 25, 30 secondes
            const countdowns = [10, 15, 20, 25, 30];
            const currentCountdown = countdowns[violationCount - 1] || 30;
            
            // MESSAGES SELON VIOLATION
            const actionText = type.includes('COPY') ? 'copier' : 
                              type.includes('CAPTURE') ? 'capturer l\'√©cran' : 
                              type.includes('DEV') ? 'utiliser des outils de d√©veloppeur' : 'acc√©der au contenu';
            
            if (violationCount === 1) {
                title.textContent = '‚ö†Ô∏è PREMI√àRE VIOLATION D√âTECT√âE';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette action a √©t√© <strong>enregistr√©e et trac√©e</strong> dans nos syst√®mes.<br><br>
                    Les questionnaires PIVAR sont prot√©g√©s par droits d'auteur.<br><br>
                    <strong>üö® AVERTISSEMENT :</strong> ${5 - violationCount} tentatives restantes avant exclusion automatique.
                `;
            } else if (violationCount === 2) {
                title.textContent = 'üü° DEUXI√àME VIOLATION - ATTENTION';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette violation a √©t√© <strong>enregistr√©e</strong> dans nos syst√®mes.<br><br>
                    <strong>‚ö†Ô∏è ATTENTION :</strong> ${5 - violationCount} tentatives restantes avant exclusion.
                `;
            } else if (violationCount === 3) {
                title.textContent = 'üü† TROISI√àME VIOLATION - S√âRIEUX';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette violation a √©t√© <strong>signal√©e</strong> √† notre √©quipe de s√©curit√©.<br><br>
                    <strong>üî∂ S√âRIEUX :</strong> ${5 - violationCount} tentatives restantes avant exclusion.
                `;
            } else if (violationCount === 4) {
                title.textContent = 'üî¥ QUATRI√àME VIOLATION - CRITIQUE';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette violation a √©t√© <strong>imm√©diatement signal√©e</strong> √† notre √©quipe.<br><br>
                    <strong>üî¥ CRITIQUE :</strong> UNE SEULE tentative restante avant exclusion d√©finitive.
                `;
            } else {
                title.textContent = 'üö´ EXCLUSION AUTOMATIQUE';
                message.innerHTML = `
                    <strong>5 violations d√©tect√©es</strong><br><br>
                    Votre session ${sessionData.id} a √©t√© <strong>automatiquement suspendue</strong>.<br><br>
                    Un rapport complet a √©t√© transmis √† notre √©quipe juridique.<br><br>
                    <strong>üìã RAPPORT G√âN√âR√â :</strong> Toutes vos actions ont √©t√© enregistr√©es.
                `;
            }
            
            popup.style.display = 'block';
            alertActive = true;
            addDebugLog(`üì± Popup violation ${violationCount} affich√©`);
            
            // COUNTDOWN
            let seconds = currentCountdown;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = seconds;
            
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    popup.style.display = 'none';
                    alertActive = false;
                    addDebugLog('‚úÖ Popup ferm√©');
                }
            }, 1000);
        }

        // ============== D√âTECTIONS FIABLES ==============
        addDebugLog('üîß Initialisation d√©tections...');

        // 1. CLIC DROIT - D√âTECTION GLOBALE
        document.addEventListener('contextmenu', function(e) {
            addDebugLog('üëÜ Clic droit d√©tect√©');
            
            // AUTORISER uniquement sur les √©l√©ments de saisie
            if (e.target.matches('input[type="text"], input[type="email"], textarea, select')) {
                addDebugLog('‚úÖ Clic droit autoris√©: champ de saisie');
                return true; // Autoriser
            }
            
            // BLOQUER partout ailleurs
            detectViolation('COPY', 'CLIC_DROIT', `Target: ${e.target.tagName}`);
            e.preventDefault();
            return false;
        }, true);

        // 2. S√âLECTION - D√âTECTION GLOBALE  
        document.addEventListener('selectstart', function(e) {
            addDebugLog('‚úèÔ∏è S√©lection d√©tect√©e');
            
            // AUTORISER uniquement dans les champs de saisie
            if (e.target.matches('input, textarea')) {
                addDebugLog('‚úÖ S√©lection autoris√©e: champ de saisie');
                return true;
            }
            
            // BLOQUER partout ailleurs
            detectViolation('COPY', 'SELECTION_TEXTE', `Target: ${e.target.tagName}`);
            e.preventDefault();
            return false;
        }, true);

        // 3. CLAVIER - D√âTECTION GLOBALE
        document.addEventListener('keydown', function(e) {
            const key = e.key ? e.key.toUpperCase() : '';
            const keyCode = e.keyCode;
            
            addDebugLog(`‚å®Ô∏è Touche: ${key} (${keyCode})`);
            
            // PRINT SCREEN - TOUJOURS BLOQU√â
            const printScreenCodes = [44, 42, 124, 183, 316, 317];
            if (key === 'PRINTSCREEN' || printScreenCodes.includes(keyCode)) {
                addDebugLog('üö® Print Screen d√©tect√© !');
                detectViolation('CAPTURE', 'PRINT_SCREEN', `Key: ${key}, Code: ${keyCode}`);
                e.preventDefault();
                return false;
            }
            
            // F11 - CAPTURE S√âLECTION
            if (key === 'F11' || keyCode === 122) {
                addDebugLog('üö® F11 capture d√©tect√© !');
                detectViolation('CAPTURE', 'F11_CAPTURE', `Key: ${key}`);
                e.preventDefault();
                return false;
            }
            
            // CTRL+S - CAPTURE
            if (e.ctrlKey && (key === 'S' || keyCode === 83)) {
                addDebugLog('üö® Ctrl+S capture d√©tect√© !');
                detectViolation('CAPTURE', 'CTRL_S_CAPTURE', `Key: ${key}`);
                e.preventDefault();
                return false;
            }
            
            // OUTILS D√âVELOPPEUR
            if (key === 'F12' || keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(key)) ||
                (e.ctrlKey && key === 'U')) {
                
                addDebugLog('üö® DevTools d√©tect√© !');
                detectViolation('DEV', 'OUTILS_DEVELOPPEUR', `Key: ${key}, Code: ${keyCode}`);
                e.preventDefault();
                return false;
            }
            
            // COPIE - AUTORISER uniquement dans champs de saisie
            if (e.ctrlKey && ['C', 'A', 'V', 'X'].includes(key)) {
                if (!e.target.matches('input, textarea')) {
                    addDebugLog('üö® Copie hors champ d√©tect√©e !');
                    detectViolation('COPY', `CTRL_${key}`, `Target: ${e.target.tagName}`);
                    e.preventDefault();
                    return false;
                } else {
                    addDebugLog('‚úÖ Copie autoris√©e: champ de saisie');
                }
            }
        }, true);

        // 4. D√âTECTION DEVTOOLS PAR DIMENSIONS
        function detectDevToolsBySize() {
            const threshold = 150;
            const widthDiff = window.outerWidth - window.innerWidth;
            const heightDiff = window.outerHeight - window.innerHeight;
            
            if (widthDiff > threshold || heightDiff > threshold) {
                addDebugLog('üö® DevTools par dimensions d√©tect√© !');
                detectViolation('DEV', 'DEVTOOLS_DIMENSIONS', `Diff: ${widthDiff}x${heightDiff}`);
            }
        }

        // 5. CHANGEMENT DE FOCUS (possible capture)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                addDebugLog('üëÅÔ∏è Page cach√©e - capture possible');
                detectViolation('SUSPECT', 'PAGE_CACHEE', 'Changement onglet/application');
            }
        });

        // ============== INITIALISATION ==============
        window.addEventListener('load', function() {
            addDebugLog('‚úÖ Syst√®me PIVAR charg√©');
            
            // Test initial Zapier
            sendToZapierImmediate({
                type: 'SESSION_START',
                method: 'INIT',
                details: 'Session d√©marr√©e'
            });
            
            // Surveillance DevTools toutes les 3 secondes
            setInterval(detectDevToolsBySize, 3000);
            
            addDebugLog('üîç D√©tections actives - testez !');
            
            console.log('üîç PIVAR MODE R√âUSSITE - D√âTECTIONS ACTIVES');
            console.log('Session:', sessionData.id);
            console.log('Testez: Clic droit, Ctrl+C, Print Screen, F12...');
        });

        // MESSAGES CONSOLE
        console.log('%cüö´ SESSION PIVAR SURVEILL√âE', 'color: #dc3545; font-size: 20px; font-weight: bold;');
        console.log('%cüèÜ Mode de R√©ussite - 7/7', 'color: #ffc107; font-size: 16px;');
        console.log('%cüìã 5 violations max: 10s‚Üí15s‚Üí20s‚Üí25s‚Üí30s', 'color: #28a745; font-size: 12px;');

    </script>
</body>
</html>
