<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Surveillance S√©curis√©e avec Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin: 0;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            user-select: none;
        }

        .header-banner h1 {
            font-size: 20px;
            margin: 0;
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            user-select: none;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .security-notice {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #155724;
            text-align: center;
            user-select: none;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 300px);
            border: none;
            display: block;
        }

        .footer {
            background: #f8f9fa;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            user-select: none;
        }

        /* Syst√®me de tracking */
        .tracking-panel {
            background: #f8f9fa;
            border-top: 2px solid #007bff;
            padding: 15px;
            font-size: 12px;
        }

        .user-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-box {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .alert-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            display: none;
        }

        .alert-critical {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        /* Notifications */
        .security-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .security-notification.show {
            transform: translateX(0);
        }

        /* Watermark de session */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 2rem;
            color: rgba(0, 0, 0, 0.05);
            z-index: 1;
            pointer-events: none;
            font-weight: bold;
            user-select: none;
        }

        @media (max-width: 768px) {
            .user-info {
                grid-template-columns: 1fr;
            }
            .watermark {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Watermark de session -->
    <div class="watermark" id="sessionWatermark">
        SESSION PIVAR SURVEILL√âE
    </div>

    <!-- En-t√™te professionnel PIVAR -->
    <div class="header-banner">
        <h1>üß† PIVAR - √âvaluation Cognitive Professionnelle</h1>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme s√©curis√©e d'√©valuation comportementale</p>
    </div>

    <!-- Barre de progression -->
    <div class="progress-bar">
        üìä QUESTIONNAIRE [X/7] : [NOM_QUESTIONNAIRE] ‚Ä¢ Session s√©curis√©e ‚Ä¢ Dur√©e estim√©e : [XX] minutes
    </div>

    <!-- Conteneur principal -->
    <div class="main-container">
        <!-- Notice de s√©curit√© discr√®te -->
        <div class="security-notice">
            ‚úÖ Session s√©curis√©e active ‚Ä¢ Vos donn√©es sont prot√©g√©es ‚Ä¢ √âvaluation confidentielle
        </div>

        <!-- Questionnaire Tally int√©gr√© -->
        <iframe 
            class="questionnaire-frame" 
            src="https://formulaires.pivar.info/r/[CODE_TALLY]"
            title="Questionnaire PIVAR S√©curis√©"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox"
            referrerpolicy="no-referrer-when-downgrade">
        </iframe>

        <!-- Panneau de tracking (visible par l'administrateur) -->
        <div class="tracking-panel">
            <h4>üìä Surveillance de Session</h4>
            
            <div class="user-info">
                <div class="info-box">
                    <strong>üë§ Utilisateur</strong><br>
                    <span id="userInfo">Identification en cours...</span>
                </div>
                <div class="info-box">
                    <strong>üïí Session</strong><br>
                    <span id="sessionInfo">D√©marr√©e √† <span id="startTime"></span></span>
                </div>
                <div class="info-box">
                    <strong>üõ°Ô∏è S√©curit√©</strong><br>
                    <span id="securityLevel">Niveau: NORMAL</span>
                </div>
            </div>

            <div id="alertContainer">
                <!-- Les alertes appara√Ætront ici -->
            </div>

            <div style="margin-top: 10px; font-size: 11px; color: #666;">
                <strong>IP:</strong> <span id="userIP">D√©tection...</span> | 
                <strong>Navigateur:</strong> <span id="userAgent"></span> |
                <strong>R√©solution:</strong> <span id="screenRes"></span>
            </div>
        </div>

        <!-- Pied de page -->
        <div class="footer">
            PIVAR ¬© 2025 ‚Ä¢ √âvaluation cognitive s√©curis√©e ‚Ä¢ Session surveill√©e et trac√©e
        </div>
    </div>

    <!-- Notification de s√©curit√© -->
    <div id="securityNotification" class="security-notification">
        Protection activ√©e
    </div>

    <script>
        // ================================
        // SYST√àME DE TRACKING COMPLET
        // ================================

        let sessionData = {
            sessionId: 'PIVAR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            startTime: new Date(),
            userAgent: navigator.userAgent,
            screenResolution: screen.width + 'x' + screen.height,
            suspiciousActivity: 0,
            violations: [],
            userInfo: null
        };

        // Configuration des protections
        const PIVAR_SECURITY = {
            enableWarnings: true,
            enableTracking: true,
            adminEmail: 'admin@pivar.info',
            webhookUrl: 'https://your-webhook-url.com/pivar-alerts' // √Ä configurer
        };

        console.log('üõ°Ô∏è PIVAR Security & Tracking System - Session:', sessionData.sessionId);

        // ================================
        // FONCTIONS DE TRACKING
        // ================================

        function initializeTracking() {
            // Obtenir l'IP de l'utilisateur
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    sessionData.userIP = data.ip;
                    document.getElementById('userIP').textContent = data.ip;
                    logSecurityEvent('SESSION_STARTED', `IP: ${data.ip}`);
                })
                .catch(() => {
                    document.getElementById('userIP').textContent = 'Non d√©tectable';
                });

            // Informations de base
            document.getElementById('startTime').textContent = sessionData.startTime.toLocaleTimeString();
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 50) + '...';
            document.getElementById('screenRes').textContent = sessionData.screenResolution;

            // Tentative d'identification utilisateur (si connect√©)
            identifyUser();

            // Mise √† jour du watermark avec l'ID de session
            document.getElementById('sessionWatermark').textContent = 
                `SESSION ${sessionData.sessionId.substr(-8)} SURVEILL√âE`;
        }

        function identifyUser() {
            // Essayer de r√©cup√©rer l'email depuis l'iframe Tally (si possible)
            // Ou depuis les param√®tres URL
            const urlParams = new URLSearchParams(window.location.search);
            const userEmail = urlParams.get('email') || urlParams.get('user');
            
            if (userEmail) {
                sessionData.userInfo = userEmail;
                document.getElementById('userInfo').innerHTML = `üìß ${userEmail}`;
                logSecurityEvent('USER_IDENTIFIED', userEmail);
            } else {
                // G√©n√©rer un ID anonyme bas√© sur les caract√©ristiques du navigateur
                const fingerprint = btoa(navigator.userAgent + screen.width + screen.height).substr(0, 12);
                sessionData.userInfo = `Anonyme_${fingerprint}`;
                document.getElementById('userInfo').innerHTML = `üîí ${sessionData.userInfo}`;
            }
        }

        function logSecurityEvent(eventType, details) {
            const event = {
                timestamp: new Date().toISOString(),
                sessionId: sessionData.sessionId,
                eventType: eventType,
                details: details,
                userInfo: sessionData.userInfo,
                userIP: sessionData.userIP,
                url: window.location.href
            };

            sessionData.violations.push(event);

            // Log local
            console.log('üö® PIVAR Security Event:', event);

            // Affichage dans l'interface admin
            displayAlert(eventType, details);

            // Envoi vers webhook (optionnel)
            if (PIVAR_SECURITY.webhookUrl) {
                sendToWebhook(event);
            }

            // Sauvegarde locale (si support√©)
            try {
                localStorage.setItem('pivar_violations_' + sessionData.sessionId, 
                    JSON.stringify(sessionData.violations));
            } catch (e) {
                // Pas de localStorage disponible
            }
        }

        function displayAlert(eventType, details) {
            const alertContainer = document.getElementById('alertContainer');
            const alertBox = document.createElement('div');
            
            let alertClass = 'alert-info';
            let icon = 'üìã';
            
            if (eventType.includes('PRINT_SCREEN') || eventType.includes('WIN_SHIFT_S')) {
                alertClass = 'alert-critical';
                icon = 'üö®';
                sessionData.suspiciousActivity += 3;
            } else if (eventType.includes('COPY') || eventType.includes('RIGHT_CLICK')) {
                alertClass = 'alert-warning';
                icon = '‚ö†Ô∏è';
                sessionData.suspiciousActivity += 1;
            } else if (eventType.includes('DEVTOOLS')) {
                alertClass = 'alert-warning';
                icon = 'üîß';
                sessionData.suspiciousActivity += 2;
            }

            alertBox.className = `alert-box ${alertClass}`;
            alertBox.style.display = 'block';
            alertBox.innerHTML = `
                <strong>${icon} ${new Date().toLocaleTimeString()}</strong> - ${eventType}<br>
                <small>${details}</small>
            `;

            alertContainer.insertBefore(alertBox, alertContainer.firstChild);

            // Limiter √† 10 alertes visibles
            const alerts = alertContainer.querySelectorAll('.alert-box');
            if (alerts.length > 10) {
                alertContainer.removeChild(alerts[alerts.length - 1]);
            }

            // Mise √† jour du niveau de s√©curit√©
            updateSecurityLevel();
        }

        function updateSecurityLevel() {
            const securityElement = document.getElementById('securityLevel');
            let level = 'NORMAL';
            let color = '#28a745';

            if (sessionData.suspiciousActivity >= 8) {
                level = 'üö® CRITIQUE';
                color = '#dc3545';
                // Alerte email critique
                sendCriticalAlert();
            } else if (sessionData.suspiciousActivity >= 5) {
                level = '‚ö†Ô∏è √âLEV√â';
                color = '#fd7e14';
            } else if (sessionData.suspiciousActivity >= 2) {
                level = 'üëÅÔ∏è SURVEILL√â';
                color = '#ffc107';
            }

            securityElement.innerHTML = `Niveau: ${level}<br><small>Score: ${sessionData.suspiciousActivity}</small>`;
            securityElement.style.color = color;
        }

        async function sendToWebhook(event) {
            try {
                await fetch(PIVAR_SECURITY.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: `üö® PIVAR Security Alert`,
                        attachments: [{
                            color: event.eventType.includes('CRITICAL') ? 'danger' : 'warning',
                            fields: [
                                { title: 'Session', value: event.sessionId, short: true },
                                { title: 'Utilisateur', value: event.userInfo || 'Anonyme', short: true },
                                { title: '√âv√©nement', value: event.eventType, short: true },
                                { title: 'D√©tails', value: event.details, short: true },
                                { title: 'IP', value: event.userIP || 'Inconnue', short: true },
                                { title: 'Heure', value: event.timestamp, short: true }
                            ]
                        }]
                    })
                });
            } catch (error) {
                console.log('Webhook non disponible:', error);
            }
        }

        function sendCriticalAlert() {
            // Envoi d'email critique (n√©cessite un service backend)
            const alertData = {
                type: 'CRITICAL_SECURITY_ALERT',
                sessionId: sessionData.sessionId,
                userInfo: sessionData.userInfo,
                suspiciousActivity: sessionData.suspiciousActivity,
                violations: sessionData.violations,
                timestamp: new Date().toISOString()
            };

            logSecurityEvent('CRITICAL_ALERT_SENT', 'Alerte critique envoy√©e');
        }

        // ================================
        // PROTECTIONS AVEC TRACKING
        // ================================

        function showSecurityNotice(message) {
            const notification = document.getElementById('securityNotification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Protection clavier avec tracking
        document.addEventListener('keydown', function(e) {
            console.log('Touche press√©e:', e.key, 'Code:', e.code, 'KeyCode:', e.keyCode);
            
            // Win+Shift+S (Outil Capture Windows)
            if (e.metaKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                e.stopPropagation();
                logSecurityEvent('WIN_SHIFT_S_BLOCKED', 'Tentative utilisation outil capture Windows');
                showSecurityNotice('üö´ Outil Capture Windows d√©tect√© et bloqu√©');
                return false;
            }

            // Print Screen - D√âTECTION COMPL√àTE avec tous les codes possibles
            if (e.key === 'PrintScreen' || 
                e.code === 'PrintScreen' || 
                e.keyCode === 44 || 
                e.keyCode === 42 ||
                e.key === 'Print' ||
                e.code === 'PrintScrn' ||
                (e.keyCode >= 42 && e.keyCode <= 47 && (e.key.includes('Print') || e.code.includes('Print')))) {
                
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                let combo = 'Print Screen';
                if (e.ctrlKey && e.altKey) combo = 'Ctrl+Alt+Print Screen';
                else if (e.altKey) combo = 'Alt+Print Screen';
                else if (e.ctrlKey) combo = 'Ctrl+Print Screen';
                else if (e.metaKey) combo = 'Win+Print Screen';
                
                logSecurityEvent('PRINT_SCREEN_BLOCKED', `${combo} - Key: ${e.key}, Code: ${e.code}, KeyCode: ${e.keyCode}`);
                showSecurityNotice(`üö´ ${combo} bloqu√© et trac√©`);
                
                // Tentative de nettoyage presse-papier
                setTimeout(async () => {
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText('üö® CONTENU PROT√âG√â PIVAR - Reproduction interdite');
                            console.log('Presse-papier nettoy√© apr√®s Print Screen');
                        }
                    } catch (err) {
                        console.log('Impossible de nettoyer le presse-papier:', err);
                    }
                }, 100);
                
                return false;
            }

            // F12 et outils d√©veloppeur
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                e.stopPropagation();
                logSecurityEvent('DEVTOOLS_SHORTCUT_BLOCKED', `${e.key} avec modificateurs`);
                showSecurityNotice('üîß Raccourci outils d√©veloppeur bloqu√©');
                return false;
            }

            // Autres raccourcis dangereux (SAUF dans champs de saisie)
            const isInInteractiveElement = e.target.matches('input, textarea, select, button, [contenteditable="true"]') ||
                                         e.target.closest('iframe');

            if (!isInInteractiveElement) {
                // Ctrl+C, Ctrl+A, Ctrl+S, etc.
                if ((e.ctrlKey && e.key === 'c') || 
                    (e.ctrlKey && e.key === 'a') || 
                    (e.ctrlKey && e.key === 's') ||
                    (e.ctrlKey && e.key === 'v')) {
                    e.preventDefault();
                    logSecurityEvent('SHORTCUT_BLOCKED', `Ctrl+${e.key.toUpperCase()} bloqu√© hors champ de saisie`);
                    showSecurityNotice('‚ö†Ô∏è Raccourci bloqu√© - Saisie autoris√©e dans les champs');
                    return false;
                }
            }
        }, true);

        // Protection clic-droit avec tracking
        document.addEventListener('contextmenu', function(e) {
            const isInInteractiveElement = e.target.matches('input, textarea, select') ||
                                         e.target.closest('iframe');
            
            if (!isInInteractiveElement) {
                e.preventDefault();
                logSecurityEvent('RIGHT_CLICK_BLOCKED', 'Menu contextuel bloqu√©');
                showSecurityNotice('üìã Menu contextuel d√©sactiv√©');
                return false;
            }
        });

        // Surveillance changement d'onglet
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                logSecurityEvent('TAB_SWITCHED', 'Utilisateur a quitt√© l\'onglet');
            } else {
                logSecurityEvent('TAB_RETURNED', 'Retour sur l\'onglet');
            }
        });

        // Surveillance DevTools
        let devToolsDetected = false;
        setInterval(function() {
            const heightDiff = window.outerHeight - window.innerHeight;
            const widthDiff = window.outerWidth - window.innerWidth;
            
            if ((heightDiff > 200 || widthDiff > 200) && !devToolsDetected) {
                devToolsDetected = true;
                logSecurityEvent('DEVTOOLS_OPENED', `Dimensions: ${widthDiff}x${heightDiff}`);
                showSecurityNotice('üîç Outils d√©veloppeur d√©tect√©s');
            } else if (heightDiff <= 200 && widthDiff <= 200 && devToolsDetected) {
                devToolsDetected = false;
                logSecurityEvent('DEVTOOLS_CLOSED', 'Outils d√©veloppeur ferm√©s');
            }
        }, 1000);

        // Initialisation
        window.addEventListener('load', function() {
            initializeTracking();
            logSecurityEvent('SESSION_INITIALIZED', 'Syst√®me de s√©curit√© activ√©');
            
            setTimeout(() => {
                showSecurityNotice('üõ°Ô∏è Session surveill√©e - Protections actives');
            }, 2000);
        });

        // Nettoyage √† la fermeture
        window.addEventListener('beforeunload', function() {
            logSecurityEvent('SESSION_ENDED', 'Fermeture de session');
        });

        // Export des donn√©es pour l'admin (fonction utilitaire)
        window.exportSecurityReport = function() {
            const report = {
                sessionId: sessionData.sessionId,
                userInfo: sessionData.userInfo,
                duration: new Date() - sessionData.startTime,
                totalViolations: sessionData.violations.length,
                suspiciousScore: sessionData.suspiciousActivity,
                violations: sessionData.violations
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pivar_security_report_${sessionData.sessionId}.json`;
            a.click();
        };
    </script>
</body>
</html>
