<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Collecte S√©curis√©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .security-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 160px);
            border: none;
            display: block;
        }

        /* BLOCAGE MOBILE */
        .device-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            text-align: center;
            padding: 20px;
        }

        .device-blocker h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }

        .device-blocker p {
            font-size: 1.1rem;
            line-height: 1.6;
            max-width: 500px;
            margin-bottom: 15px;
        }

        /* TABLETTE WARNING */
        .tablet-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
        }

        /* TRACKING INDICATOR */
        .tracking-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* POPUP DE DISSUASION */
        .violation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 35px;
            border-radius: 15px;
            border: 4px solid #dc3545;
            box-shadow: 0 0 50px rgba(220, 53, 69, 0.3);
            z-index: 999999;
            display: none;
            text-align: center;
            max-width: 600px;
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #dc3545;
        }

        .popup-message {
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #333;
        }

        .popup-countdown {
            font-size: 1.1rem;
            color: #dc3545;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .device-blocker { display: flex; }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .tablet-warning { display: block; }
        }
    </style>
</head>
<body>
    <!-- BLOCAGE MOBILE -->
    <div class="device-blocker" id="mobileBlocker">
        <h1>üì± Acc√®s Smartphone Non Autoris√©</h1>
        <p><strong>Cette √©valuation PIVAR n√©cessite un √©cran plus grand pour une exp√©rience optimale.</strong></p>
        <p>L'interface dans un smartphone rendrait la saisie difficile et frustrante.</p>
        <p><strong>Veuillez utiliser un ordinateur ou une tablette (10 pouces minimum).</strong></p>
        
        <div style="margin-top: 30px; font-size: 0.9rem; opacity: 0.8;">
            Device d√©tect√©: <span id="deviceType">Smartphone</span><br>
            Session: <span id="sessionId">Loading...</span>
        </div>
    </div>

    <!-- TRACKING INDICATOR -->
    <div class="tracking-indicator" id="trackingIndicator">
        üîç SESSION SURVEILL√âE
    </div>

    <!-- Interface principale -->
    <div class="main-container">
        <!-- Warning tablette -->
        <div class="tablet-warning" id="tabletWarning" style="display: none;">
            ‚ö†Ô∏è <strong>TABLETTE D√âTECT√âE</strong> - Assurez-vous que le questionnaire s'affiche correctement. 
            En cas de probl√®me d'affichage, utilisez un ordinateur.
        </div>

        <div class="header-banner">
            <h1>üß† PIVAR ‚Äì Protocole d'identification et de valorisation de l'action et de la r√©ussite</h1>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme s√©curis√©e d'√©valuation comportementale</p>
        </div>

        <div class="progress-bar">
            üìä QUESTIONNAIRE 2/7 : PILIER COLLECTE ‚Ä¢ Session surveill√©e et enregistr√©e
        </div>

        <div class="security-notice">
            ‚ö†Ô∏è ATTENTION : Cette session est enti√®rement surveill√©e et enregistr√©e ‚Ä¢ Toute tentative de copie ou capture sera d√©tect√©e et trac√©e ‚Ä¢ Questionnaires prot√©g√©s par droits d'auteur
        </div>

        <iframe 
            class="questionnaire-frame" 
            src="https://tally.so/r/wMG4Lg"
            title="Questionnaire PIVAR Collecte"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-top-navigation">
        </iframe>
    </div>

    <!-- POPUP VIOLATION -->
    <div id="violationPopup" class="violation-popup">
        <div class="popup-title" id="popupTitle">üö® VIOLATION D√âTECT√âE</div>
        <div class="popup-message" id="popupMessage">Message</div>
        <div class="popup-countdown">Retour dans <span id="countdown">8</span> secondes</div>
    </div>

    <script>
        // ============== D√âTECTION DEVICE PR√âCISE ==============
        const deviceInfo = {
            userAgent: navigator.userAgent,
            isMobile: /iPhone|Android.*Mobile|Windows Phone|BlackBerry/i.test(navigator.userAgent),
            isTablet: /iPad|Android(?!.*Mobile)|Tablet|PlayBook|Silk/i.test(navigator.userAgent) ||
                     (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1),
            screenWidth: window.screen.width,
            screenHeight: window.screen.height,
            touchPoints: navigator.maxTouchPoints || 0
        };

        const sessionData = {
            id: 'PIVAR_' + Date.now().toString(36).toUpperCase(),
            questionnaire: 'COLLECTE',
            violations: [],
            totalViolations: 0,
            device: deviceInfo
        };

        let alertActive = false;

        // ============== POLITIQUE DEVICE ==============
        function handleDevicePolicy() {
            // BLOQUER MOBILE
            if (deviceInfo.isMobile) {
                document.getElementById('mobileBlocker').style.display = 'flex';
                document.getElementById('deviceType').textContent = 'Smartphone';
                document.getElementById('sessionId').textContent = sessionData.id;
                console.log('üì± BLOQU√â: Smartphone d√©tect√©');
                return false;
            }
            
            // AVERTIR TABLETTE
            if (deviceInfo.isTablet) {
                document.getElementById('tabletWarning').style.display = 'block';
                document.getElementById('trackingIndicator').textContent = '‚ö†Ô∏è TABLETTE SURVEILL√âE';
                document.getElementById('trackingIndicator').style.background = '#fd7e14';
                console.log('üì± TABLETTE: Acc√®s autoris√© avec avertissement');
                return true;
            }
            
            // DESKTOP OK
            console.log('üíª DESKTOP: Acc√®s normal');
            return true;
        }

        // ============== SYST√àME ZAPIER ==============
        function sendToZapier(violationData) {
            const zapierWebhook = 'https://hooks.zapier.com/hooks/catch/YOUR_WEBHOOK_ID/';
            
            const payload = {
                session_id: sessionData.id,
                questionnaire: sessionData.questionnaire,
                timestamp: new Date().toISOString(),
                violation_count: sessionData.totalViolations,
                violation_details: violationData,
                device_info: deviceInfo,
                status: sessionData.totalViolations >= 3 ? 'EXCLU' : 'SURVEILLANCE'
            };

            fetch(zapierWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(err => console.log('üì° Zapier:', err));

            console.log('üì° ZAPIER:', payload);
        }

        // ============== D√âTECTION VIOLATIONS ==============
        function detectViolation(type, method, details) {
            if (alertActive) return;
            
            const violationData = {
                type: type,
                method: method,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            sessionData.violations.push(violationData);
            sessionData.totalViolations++;
            
            // Envoyer vers Zapier
            sendToZapier(violationData);
            
            // Popup dissuasif
            showViolationPopup(type, method);
            
            // Exclusion √† 3 violations
            if (sessionData.totalViolations >= 3) {
                setTimeout(() => {
                    sendToZapier({
                        type: 'EXCLUSION',
                        method: 'AUTO_EXCLUDE',
                        details: 'Candidat exclu apr√®s 3 violations'
                    });
                    alert(`Session ${sessionData.id} suspendue apr√®s 3 violations.`);
                    window.location.href = 'https://pivar.info/droits-auteur.html';
                }, 8000);
            }
        }

        // ============== POPUP DISSUASION ==============
        function showViolationPopup(type, method) {
            const popup = document.getElementById('violationPopup');
            const title = document.getElementById('popupTitle');
            const message = document.getElementById('popupMessage');
            
            const count = sessionData.totalViolations;
            const actionText = type.includes('DEV') ? 'utiliser des outils de d√©veloppeur' : 
                              type.includes('COPY') ? 'copier le contenu' : 'capturer l\'√©cran';
            
            if (count === 1) {
                title.textContent = '‚ö†Ô∏è PREMI√àRE VIOLATION D√âTECT√âE';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette action a √©t√© <strong>enregistr√©e et trac√©e</strong> dans nos syst√®mes.<br><br>
                    Les questionnaires PIVAR sont prot√©g√©s par droits d'auteur.<br><br>
                    <strong>üö® AVERTISSEMENT :</strong> ${3 - count} tentatives restantes avant exclusion.
                `;
            } else if (count === 2) {
                title.textContent = 'üö® DEUXI√àME VIOLATION - DERNIER AVERTISSEMENT';
                message.innerHTML = `
                    <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                    Cette violation a √©t√© <strong>imm√©diatement signal√©e</strong> √† notre √©quipe.<br><br>
                    <strong>‚õî DERNI√àRE CHANCE :</strong> La prochaine violation entra√Ænera votre exclusion d√©finitive.
                `;
            } else {
                title.textContent = 'üö´ EXCLUSION AUTOMATIQUE';
                message.innerHTML = `
                    <strong>3 violations d√©tect√©es</strong><br><br>
                    Votre session ${sessionData.id} a √©t√© <strong>automatiquement suspendue</strong>.<br><br>
                    Un rapport complet a √©t√© transmis √† notre √©quipe juridique.
                `;
            }
            
            popup.style.display = 'block';
            alertActive = true;
            
            let seconds = 8;
            const countdownEl = document.getElementById('countdown');
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    popup.style.display = 'none';
                    alertActive = false;
                }
            }, 1000);
        }

        // ============== D√âTECTIONS SP√âCIFIQUES √Ä VOTRE CONFIG ==============
        
        // 1. D√©tection captures (VOS TOUCHES)
        document.addEventListener('keydown', function(e) {
            const key = e.key?.toUpperCase() || '';
            const keyCode = e.keyCode;
            
            // CAPTURES SP√âCIFIQUES √Ä VOTRE PC
            const captureDetected = 
                key === 'F11' ||                           // Votre F11 = capture s√©lection
                keyCode === 44 ||                          // Print Screen standard
                key === 'PRINTSCREEN' ||                   // Print Screen nomm√©
                (e.ctrlKey && key === 'S') ||             // Votre Ctrl+S = capture
                (e.shiftKey && e.metaKey && key === 'S'); // Win+Shift+S

            if (captureDetected) {
                e.preventDefault();
                detectViolation('CAPTURE', `${e.ctrlKey ? 'CTRL+' : ''}${e.shiftKey ? 'SHIFT+' : ''}${e.metaKey ? 'WIN+' : ''}${key}`, `KeyCode: ${keyCode}`);
                return false;
            }
            
            // OUTILS D√âVELOPPEUR
            const devDetected = 
                key === 'F12' ||                                        // F12 standard
                (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(key)) || // DevTools
                (e.ctrlKey && key === 'U');                            // Code source

            if (devDetected) {
                e.preventDefault();
                detectViolation('DEV', `${e.ctrlKey ? 'CTRL+' : ''}${e.shiftKey ? 'SHIFT+' : ''}${key}`, 'Outils d√©veloppeur');
                return false;
            }
            
            // COPIE (seulement hors iframe et inputs)
            if (e.ctrlKey && ['C', 'A', 'V', 'X'].includes(key)) {
                if (!e.target.closest('iframe') && !e.target.matches('input, textarea')) {
                    detectViolation('COPY', `CTRL+${key}`, 'Raccourci copie hors zone autoris√©e');
                    // Ne pas emp√™cher - juste d√©tecter pour dissuasion
                }
            }
        });

        // 2. D√©tection clic droit (sans bloquer)
        document.addEventListener('contextmenu', function(e) {
            // D√©tecter mais ne pas bloquer
            detectViolation('COPY', 'CLIC_DROIT', 'Menu contextuel ouvert');
        });

        // 3. D√©tection s√©lection (sans bloquer)
        document.addEventListener('selectstart', function(e) {
            if (!e.target.closest('iframe')) {
                detectViolation('COPY', 'SELECTION_TEXTE', 'S√©lection de texte tent√©e');
            }
        });

        // 4. D√©tection DevTools par dimensions
        function detectDevTools() {
            const threshold = 150;
            if (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold) {
                detectViolation('DEV', 'DEVTOOLS_OUVERT', `Dimensions: ${window.outerWidth}x${window.outerHeight}`);
            }
        }

        // ============== INITIALISATION ==============
        window.addEventListener('load', function() {
            if (handleDevicePolicy()) {
                document.getElementById('trackingIndicator').textContent = `üîç ${sessionData.id}`;
                
                console.log('üîç PIVAR TRACKING ACTIV√â');
                console.log('üìä Device:', deviceInfo);
                console.log('üéØ D√âTECTIONS CONFIGUR√âES POUR VOTRE PC:');
                console.log('- F11 = Capture s√©lection');
                console.log('- Impr √âcran = Capture');
                console.log('- Ctrl+S = Capture');
                console.log('- F12 = DevTools (si configur√©)');
                console.log('- Ctrl+Shift+I = DevTools');
                
                // Surveillance DevTools
                setInterval(detectDevTools, 5000);
                
                // Test initial Zapier
                sendToZapier({
                    type: 'SESSION_START',
                    method: 'INIT',
                    details: 'Session d√©marr√©e'
                });
            }
        });

        console.log('%cüö´ ATTENTION - SESSION SURVEILL√âE', 'color: #dc3545; font-size: 20px; font-weight: bold;');
        console.log('%cToute action suspecte est d√©tect√©e et enregistr√©e - Session: ' + sessionData.id, 'color: #dc3545; font-size: 14px;');

    </script>
</body>
</html>
