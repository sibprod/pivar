<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIVAR - Collecte S√©curis√© - Version Valid√©e</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 100px);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .security-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 0;
            font-size: 13px;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }

        .rgpd-notice {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin: 0;
            font-size: 12px;
            color: #155724;
            text-align: center;
        }

        .questionnaire-frame {
            width: 100%;
            height: calc(100vh - 220px);
            border: none;
            display: block;
        }

        /* TRACKING INDICATOR */
        .tracking-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 1000;
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* AUDIT PANEL */
        .audit-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            max-width: 400px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        /* POPUP VIOLATION - CONFORME RAPPORT */
        .violation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 35px;
            border-radius: 15px;
            border: 4px solid #dc3545;
            box-shadow: 0 0 50px rgba(220, 53, 69, 0.3);
            z-index: 999999;
            display: none;
            text-align: center;
            max-width: 600px;
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #dc3545;
        }

        .popup-message {
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
            color: #333;
        }

        .popup-countdown {
            font-size: 1.1rem;
            color: #dc3545;
            font-weight: bold;
        }

        /* Couleurs d'escalade conformes rapport */
        .violation-1 { 
            border-color: #ffc107; 
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
        }
        .violation-2 { 
            border-color: #fd7e14; 
            box-shadow: 0 0 40px rgba(253, 126, 20, 0.4);
        }
        .violation-3 { 
            border-color: #dc3545; 
            background: #f8f9fa;
            box-shadow: 0 0 50px rgba(220, 53, 69, 0.5);
        }

        /* BLOCAGE MOBILE CONFORME RAPPORT */
        .device-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .device-blocker { display: flex; }
        }

        /* TABLETTE WARNING */
        .tablet-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            margin: 0;
            text-align: center;
            font-weight: 500;
            font-size: 13px;
            display: none;
        }

        @media (min-width: 769px) and (max-width: 1024px) and (pointer: coarse) {
            .tablet-warning { display: block; }
        }
    </style>
</head>
<body>
    <!-- BLOCAGE MOBILE CONFORME RAPPORT -->
    <div class="device-blocker">
        <h1>üì± Acc√®s Smartphone Non Autoris√©</h1>
        <p><strong>Cette √©valuation PIVAR n√©cessite un ordinateur ou tablette.</strong></p>
        <p>L'interface questionnaire ne s'affiche pas correctement sur smartphone.</p>
        <p><strong>Veuillez utiliser un ordinateur ou une tablette (10 pouces minimum).</strong></p>
        
        <div style="margin-top: 30px; font-size: 0.9rem; opacity: 0.8;">
            Device d√©tect√©: <span id="deviceType">Smartphone</span><br>
            Session: <span id="sessionMobile">Loading...</span>
        </div>
    </div>

    <!-- TRACKING INDICATOR -->
    <div class="tracking-indicator" id="trackingIndicator">
        üîç SESSION SURVEILL√âE
    </div>

    <!-- AUDIT PANEL -->
    <div class="audit-panel" id="auditPanel">
        <div><strong>üîç AUDIT SYST√àME PIVAR:</strong></div>
        <div id="auditLogs">Initialisation audit...</div>
    </div>

    <!-- Interface principale -->
    <div class="main-container">
        <!-- WARNING TABLETTE CONFORME RAPPORT -->
        <div class="tablet-warning" id="tabletWarning">
            ‚ö†Ô∏è <strong>TABLETTE D√âTECT√âE</strong> - Assurez-vous que le questionnaire s'affiche correctement. 
            En cas de probl√®me d'affichage, utilisez un ordinateur.
        </div>

        <div class="header-banner">
            <h1>üß† PIVAR ‚Äì Protocole d'identification et de valorisation de l'action et de la r√©ussite</h1>
            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Plateforme s√©curis√©e d'√©valuation comportementale</p>
        </div>

        <div class="progress-bar">
            üìä QUESTIONNAIRE 2/7 : PILIER COLLECTE ‚Ä¢ Session surveill√©e et enregistr√©e
        </div>

        <div class="security-notice">
            ‚ö†Ô∏è ATTENTION : Cette session est enti√®rement surveill√©e et enregistr√©e ‚Ä¢ Toute tentative de copie ou capture sera d√©tect√©e et trac√©e ‚Ä¢ Questionnaires prot√©g√©s par droits d'auteur
        </div>

        <div class="rgpd-notice">
            üìã <strong>Information RGPD :</strong> Conform√©ment √† l'article 6.1.f du RGPD, cette session technique est enregistr√©e sur la base de nos int√©r√™ts l√©gitimes de protection de la propri√©t√© intellectuelle et de pr√©vention des violations de droits d'auteur. Ce traitement est n√©cessaire √† la protection de nos questionnaires prot√©g√©s et proportionn√© √† cet objectif l√©gitime.
        </div>

        <iframe 
            class="questionnaire-frame" 
            src="https://tally.so/r/wMG4Lg"
            title="Questionnaire PIVAR Collecte"
            allowtransparency="true"
            sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-top-navigation">
        </iframe>
    </div>

    <!-- POPUP VIOLATION CONFORME RAPPORT -->
    <div id="violationPopup" class="violation-popup">
        <div class="popup-title" id="popupTitle">‚ö†Ô∏è PREMI√àRE VIOLATION D√âTECT√âE</div>
        <div class="popup-message" id="popupMessage">Message conforme rapport</div>
        <div class="popup-countdown">Retour dans <span id="countdown">8</span> secondes</div>
    </div>

    <script>
        // ============== VARIABLES CONFORMES RAPPORT ==============
        const sessionData = {
            id: 'PIVAR_' + Date.now().toString(36).toUpperCase(),
            questionnaire: 'COLLECTE',
            violations: [],
            totalViolations: 0,
            devViolations: 0,
            deviceInfo: {
                userAgent: navigator.userAgent,
                isMobile: /iPhone|Android.*Mobile|Windows Phone|BlackBerry/i.test(navigator.userAgent),
                isTablet: /iPad|Android(?!.*Mobile)|Tablet|PlayBook|Silk/i.test(navigator.userAgent) ||
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1),
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                touchPoints: navigator.maxTouchPoints || 0,
                platform: navigator.platform
            }
        };

        let alertActive = false;
        let auditLogs = [];

        // Afficher session ID
        document.getElementById('trackingIndicator').textContent = `üîç ${sessionData.id}`;
        if (document.getElementById('sessionMobile')) {
            document.getElementById('sessionMobile').textContent = sessionData.id;
        }

        // ============== FONCTION AUDIT ==============
        function addAuditLog(message, status = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp}: ${message}`;
            auditLogs.push(logEntry);
            
            const auditPanel = document.getElementById('auditLogs');
            auditPanel.innerHTML = auditLogs.slice(-4).join('<br>');
            
            console.log(`üîç AUDIT: ${logEntry}`);
        }

        // ============== POLITIQUE DEVICE CONFORME RAPPORT ==============
        function handleDevicePolicy() {
            addAuditLog('V√©rification politique device...');
            
            // BLOQUER MOBILE (conforme rapport)
            if (sessionData.deviceInfo.isMobile) {
                document.getElementById('deviceType').textContent = 'Smartphone';
                addAuditLog('BLOQU√â: Smartphone d√©tect√©', 'error');
                return false;
            }
            
            // AVERTIR TABLETTE (conforme rapport)
            if (sessionData.deviceInfo.isTablet) {
                document.getElementById('tabletWarning').style.display = 'block';
                document.getElementById('trackingIndicator').textContent = `‚ö†Ô∏è TABLETTE ${sessionData.id}`;
                document.getElementById('trackingIndicator').style.background = '#fd7e14';
                addAuditLog('TABLETTE: Acc√®s autoris√© avec avertissement', 'warning');
                return true;
            }
            
            // DESKTOP OK (conforme rapport)
            addAuditLog('DESKTOP: Acc√®s optimal autoris√©', 'success');
            return true;
        }

        // ============== SYST√àME ZAPIER CONFORME RAPPORT ==============
        function sendToZapierImmediate(violationData) {
            const zapierWebhook = 'https://hooks.zapier.com/hooks/catch/YOUR_WEBHOOK_ID/';
            
            const payload = {
                session_id: sessionData.id,
                questionnaire: sessionData.questionnaire,
                timestamp: new Date().toISOString(),
                violation_count: sessionData.totalViolations + sessionData.devViolations + 1,
                violation_details: violationData,
                priority: 'IMMEDIATE',
                device_info: sessionData.deviceInfo,
                status: (sessionData.totalViolations + sessionData.devViolations >= 2) ? 'EXCLU' : 'SURVEILLANCE'
            };

            // ENVOI GARANTI (conforme rapport)
            navigator.sendBeacon(zapierWebhook, JSON.stringify(payload));
            
            fetch(zapierWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                keepalive: true
            }).catch(() => {
                addAuditLog('Zapier: Beacon envoy√© (fetch failed)', 'info');
            });

            console.log('üì° ZAPIER PAYLOAD:', payload);
            addAuditLog(`üì° Zapier envoy√©: ${violationData.type}`, 'success');
        }

        // ============== MESSAGES EXACTS CONFORMES RAPPORT ==============
        function showViolationPopup(type, method, isDevViolation = false) {
            const popup = document.getElementById('violationPopup');
            const title = document.getElementById('popupTitle');
            const message = document.getElementById('popupMessage');
            
            if (isDevViolation) {
                // R√àGLES SP√âCIALES OUTILS DEV (conforme rapport)
                if (sessionData.devViolations === 1) {
                    popup.className = 'violation-popup violation-1';
                    title.textContent = 'Information Importante';
                    message.innerHTML = `
                        R√©pondre √† ce questionnaire ne n√©cessite aucune fonctionnalit√© de type <strong>${method}</strong>.<br><br>
                        Nous vous recommandons de suivre votre parcours en r√©pondant √† vos questions.
                    `;
                } else {
                    popup.className = 'violation-popup violation-3';
                    title.textContent = 'Parcours Suspendu';
                    message.innerHTML = `
                        <strong>Tentative de violation suspect√©e.</strong><br><br>
                        Votre parcours est suspendu, et nous allons aviser notre service juridique.<br><br>
                        Un membre de notre √©quipe reviendra vers vous.
                    `;
                }
            } else {
                // VIOLATIONS G√âN√âRALES (conforme rapport)
                const count = sessionData.totalViolations;
                const actionText = type.includes('COPY') ? 'copier' : type.includes('CAPTURE') ? 'capturer l\'√©cran' : 'acc√©der au contenu';
                
                if (count === 1) {
                    popup.className = 'violation-popup violation-1';
                    title.textContent = '‚ö†Ô∏è PREMI√àRE VIOLATION D√âTECT√âE';
                    message.innerHTML = `
                        <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                        Cette action a √©t√© <strong>enregistr√©e et trac√©e</strong> dans nos syst√®mes.<br><br>
                        Les questionnaires PIVAR sont prot√©g√©s par droits d'auteur.<br><br>
                        <strong>üö® AVERTISSEMENT :</strong> ${3 - count} tentatives restantes avant exclusion automatique.
                    `;
                } else if (count === 2) {
                    popup.className = 'violation-popup violation-2';
                    title.textContent = 'üö® DEUXI√àME VIOLATION - DERNIER AVERTISSEMENT';
                    message.innerHTML = `
                        <strong>Action d√©tect√©e :</strong> Tentative de ${actionText} (${method})<br><br>
                        Cette violation a √©t√© <strong>imm√©diatement signal√©e</strong> √† notre √©quipe de s√©curit√©.<br><br>
                        Votre session compl√®te est sous surveillance.<br><br>
                        <strong>‚õî DERNI√àRE CHANCE :</strong> La prochaine violation entra√Ænera votre exclusion d√©finitive du questionnaire.
                    `;
                } else {
                    popup.className = 'violation-popup violation-3';
                    title.textContent = 'üö´ EXCLUSION AUTOMATIQUE';
                    message.innerHTML = `
                        <strong>3 violations d√©tect√©es</strong><br><br>
                        Votre session ${sessionData.id} a √©t√© <strong>automatiquement suspendue</strong>.<br><br>
                        Un rapport complet a √©t√© transmis √† notre √©quipe juridique.<br><br>
                        <strong>üìã RAPPORT G√âN√âR√â :</strong> Toutes vos actions ont √©t√© enregistr√©es et seront analys√©es par notre √©quipe.
                    `;
                }
            }
            
            popup.style.display = 'block';
            alertActive = true;
            addAuditLog(`Popup violation ${isDevViolation ? 'DEV' : 'GEN'} affich√©`, 'warning');
            
            let seconds = 8;
            const countdownEl = document.getElementById('countdown');
            const interval = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    popup.style.display = 'none';
                    alertActive = false;
                    addAuditLog('Popup ferm√©', 'info');
                }
            }, 1000);
        }

        // ============== D√âTECTION VIOLATIONS CONFORME RAPPORT ==============
        function detectViolation(type, method, details, isFirstTime = false) {
            addAuditLog(`üö® VIOLATION: ${type} - ${method}`, 'error');
            
            const violationData = {
                type: type,
                method: method,
                details: details,
                timestamp: new Date().toISOString(),
                first_time: isFirstTime
            };
            
            // ENVOI IMM√âDIAT ZAPIER (conforme rapport)
            sendToZapierImmediate(violationData);
            
            const isDevViolation = ['DEV', 'OUTILS_DEVELOPPEUR'].some(keyword => 
                type.includes(keyword) || method.includes(keyword));
            
            if (isDevViolation) {
                sessionData.devViolations++;
                addAuditLog(`DevViolations: ${sessionData.devViolations}`, 'warning');
                
                if (sessionData.devViolations >= 2) {
                    setTimeout(() => {
                        alert(`Session ${sessionData.id} suspendue.\nNotre √©quipe reprendra contact avec vous.`);
                        window.location.href = 'https://pivar.info/droits-auteur.html';
                    }, 8000);
                }
            } else {
                sessionData.violations.push(violationData);
                sessionData.totalViolations++;
                addAuditLog(`TotalViolations: ${sessionData.totalViolations}`, 'warning');
                
                if (sessionData.totalViolations >= 3) {
                    setTimeout(() => {
                        alert(`Session ${sessionData.id} suspendue apr√®s 3 infractions.\nNotre √©quipe reprendra contact avec vous.`);
                        window.location.href = 'https://pivar.info/droits-auteur.html';
                    }, 8000);
                }
            }
            
            if (!alertActive) {
                showViolationPopup(type, method, isDevViolation);
            }
        }

        // ============== D√âTECTIONS TECHNIQUES CONFORMES RAPPORT ==============

        // 1. CLIC DROIT
        document.addEventListener('contextmenu', function(e) {
            addAuditLog('Event: contextmenu d√©tect√©', 'info');
            detectViolation('COPY', 'CLIC_DROIT', `Target: ${e.target.tagName}`);
            // Ne pas bloquer pour permettre test
        }, true);

        // 2. S√âLECTION
        document.addEventListener('selectstart', function(e) {
            if (!e.target.closest('iframe')) {
                addAuditLog('Event: selectstart d√©tect√©', 'info');
                detectViolation('COPY', 'SELECTION_TEXTE', `Target: ${e.target.tagName}`);
            }
        }, true);

        // 3. CLAVIER CONFORME CONFIG CLIENT
        document.addEventListener('keydown', function(e) {
            if (e.target.closest('iframe')) return; // Autoriser dans iframe
            
            const key = e.key?.toUpperCase() || '';
            const keyCode = e.keyCode;
            
            addAuditLog(`Touche: ${key} (${keyCode})`, 'info');
            
            // PRINT SCREEN CODES √âTENDUS
            const printScreenCodes = [44, 42, 124, 183, 316, 317];
            if (key === 'PRINTSCREEN' || 
                printScreenCodes.includes(keyCode) ||
                (key === 'Unidentified' && keyCode > 40 && keyCode < 200)) {
                
                e.preventDefault();
                detectViolation('CAPTURE', 'PRINT_SCREEN', `Key: ${key}, Code: ${keyCode}`, true);
                return false;
            }
            
            // F11 CAPTURE S√âLECTION (CONFIG CLIENT)
            if (key === 'F11' || keyCode === 122) {
                e.preventDefault();
                detectViolation('CAPTURE', 'F11_CAPTURE', `Key: ${key}, Code: ${keyCode}`, true);
                return false;
            }
            
            // CTRL+S CAPTURE (CONFIG CLIENT)
            if (e.ctrlKey && (key === 'S' || keyCode === 83)) {
                e.preventDefault();
                detectViolation('CAPTURE', 'CTRL_S_CAPTURE', `Key: ${key}, Code: ${keyCode}`, true);
                return false;
            }
            
            // OUTILS D√âVELOPPEUR
            if (key === 'F12' || 
                keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(key)) ||
                (e.ctrlKey && key === 'U')) {
                
                e.preventDefault();
                detectViolation('DEV', 'OUTILS_DEVELOPPEUR', `Key: ${key}, Code: ${keyCode}`, true);
                return false;
            }
            
            // COPIE HORS IFRAME
            if (e.ctrlKey && ['C', 'A', 'V', 'X'].includes(key)) {
                if (!e.target.matches('input, textarea')) {
                    detectViolation('COPY', `CTRL_${key}`, `Target: ${e.target.tagName}`);
                }
            }
        }, true);

        // 4. D√âTECTION DEVTOOLS PAR DIMENSIONS
        function detectDevTools() {
            const threshold = 150;
            if (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold) {
                addAuditLog('DevTools dimensions d√©tect√©es', 'warning');
                detectViolation('DEV', 'DEVTOOLS_DIMENSIONS', `Taille: ${window.outerWidth}x${window.outerHeight}`);
            }
        }

        // ============== INITIALISATION CONFORME RAPPORT ==============
        window.addEventListener('load', function() {
            addAuditLog('Initialisation syst√®me PIVAR...', 'info');
            
            if (handleDevicePolicy()) {
                addAuditLog('Politique device: AUTORIS√â', 'success');
                addAuditLog(`Session: ${sessionData.id}`, 'info');
                addAuditLog('D√©tections actives: ‚úì', 'success');
                
                // Surveillance DevTools
                setInterval(detectDevTools, 3000);
                
                // Test initial Zapier
                sendToZapierImmediate({
                    type: 'SESSION_START',
                    method: 'INIT',
                    details: 'Session d√©marr√©e - syst√®me valid√©'
                });
                
                addAuditLog('‚úÖ Syst√®me op√©rationnel', 'success');
            } else {
                addAuditLog('Politique device: BLOQU√â', 'error');
            }
        });

        // MESSAGES CONSOLE CONFORMES RAPPORT
        console.log('%cüîç SYST√àME PIVAR AUDIT VALID√â', 'color: #28a745; font-size: 16px; font-weight: bold;');
        console.log('%cüìã RGPD Article 6.1.f - Base l√©gale conforme', 'color: #856404; font-size: 12px;');
        console.log('%cüéØ Efficacit√© vis√©e: 85-95% - Messages conformes rapport', 'color: #3498db; font-size: 12px;');

    </script>
</body>
</html>
